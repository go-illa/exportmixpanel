{% extends "layout.html" %}
{% block content %}
<style>
  /* Ensure the table headers remain visible while scrolling horizontally */
  .table-container {
    width: 100%;
    overflow-x: auto;
  }
  .custom-table {
    min-width: 1800px;
    border-collapse: separate;
    border-spacing: 0;
  }
  .custom-table th,
  .custom-table td {
    white-space: nowrap;
    padding: 0.5rem;
    border: 1px solid #ddd;
  }
  /* Sticky header */
  .custom-table thead th {
    position: static;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
  }
  /* Sticky first column (Trip ID) */
  .custom-table th:first-child,
  .custom-table td:first-child {
    position: static;
    left: 0;
    background: #f8f9fa;
    z-index: 11;
  }
</style>
<style>
  .modal {
    z-index: 1055 !important;
  }
  .modal-backdrop {
    z-index: 1050 !important;
  }

  .mt-4{
    
margin-left: 3%;
margin-right: 3%;
max-width: 100%;

  }

.container{
 width: 94%;
 }
</style>

<div class="card mb-4 animate__animated animate__fadeInUp" style="padding-left: 3%; padding-right: 3%;">
  <div class="card-body">
    <h2 class="card-title">Trips</h2>
    <form class="row g-3" method="GET" action="{{ url_for('trips') }}" id="filterForm">
      <div class="col-md-2">
        <input type="text" name="trip_id" class="form-control" placeholder="Trip ID" value="{{ trip_id_search }}" />
      </div>
      <div class="col-md-2">
        <select name="route_quality" class="form-select">
          <option value="">-- Route Quality --</option>
          <option value="Not Assigned" {% if route_quality_filter|lower == "not assigned" %}selected{% endif %}>Not Assigned</option>
          <option value="No Logs Trips" {% if route_quality_filter == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
          <option value="Trip Points Only Exist" {% if route_quality_filter == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
          <option value="Low" {% if route_quality_filter == "Low" %}selected{% endif %}>Low</option>
          <option value="Moderate" {% if route_quality_filter == "Moderate" %}selected{% endif %}>Moderate</option>
          <option value="High" {% if route_quality_filter == "High" %}selected{% endif %}>High</option>
        </select>
      </div>
      <!-- Expected Trip Quality Filter -->
<div class="col-md-2">
  <select name="expected_trip_quality" class="form-select">
    <option value="">-- Expected Trip Quality --</option>
    <option value="High Quality Trip" {% if expected_trip_quality_filter == "High Quality Trip" %}selected{% endif %}>High Quality Trip</option>
    <option value="Moderate Quality Trip" {% if expected_trip_quality_filter == "Moderate Quality Trip" %}selected{% endif %}>Moderate Quality Trip</option>
    <option value="Low Quality Trip" {% if expected_trip_quality_filter == "Low Quality Trip" %}selected{% endif %}>Low Quality Trip</option>
    <option value="No Logs Trip" {% if expected_trip_quality_filter == "No Logs Trip" %}selected{% endif %}>No Logs Trip</option>
    <option value="Trip Points Only Exist" {% if expected_trip_quality_filter == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
  </select>
</div>

      <div class="col-md-2">
        <select name="model" class="form-select">
          <option value="">-- Model --</option>
          {% for key, display in models_options %}
            <option value="{{ key }}" {% if model_filter == key %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="ram" class="form-control" placeholder="RAM" value="{{ ram_filter }}" />
      </div>
      <div class="col-md-2">
        <select name="carrier" class="form-select">
          <option value="">-- Select Carrier --</option>
          {% for c in carriers_for_dropdown %}
          <option value="{{ c }}" {% if c == carrier_filter %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_min" class="form-control" placeholder="Variance Min (%)" value="{{ variance_min }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_max" class="form-control" placeholder="Variance Max (%)" value="{{ variance_max }}" />
      </div>
      <div class="col-md-2">
        <select name="driver" class="form-select">
          <option value="">-- Select Driver --</option>
          {% for d in drivers %}
          <option value="{{ d }}" {% if d == driver_filter %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- New Row: Trip Time Range -->
      <div class="col-md-2">
        <input type="text" name="trip_time_min" class="form-control" placeholder="Trip Time Min (h)" value="{{ request.args.get('trip_time_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="trip_time_max" class="form-control" placeholder="Trip Time Max (h)" value="{{ request.args.get('trip_time_max','') }}" />
      </div>
      <!-- Existing Trip Time Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="trip_time_op" class="form-select">
          <option value="equal" {% if request.args.get('trip_time_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('trip_time_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('trip_time_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('trip_time_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('trip_time_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="trip_time" class="form-control" placeholder="Trip Time (h)" value="{{ request.args.get('trip_time','') }}" />
      </div>
      <div class="col-md-2">
        <select name="completed_by" class="form-select">
          <option value="">-- Completed By --</option>
          {% for cb in completed_by_options %}
            <option value="{{ cb }}" {% if request.args.get('completed_by','') == cb %}selected{% endif %}>{{ cb }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- New Row: Log Count Range -->
      <div class="col-md-2">
        <input type="text" name="log_count_min" class="form-control" placeholder="Log Count Min" value="{{ request.args.get('log_count_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="log_count_max" class="form-control" placeholder="Log Count Max" value="{{ request.args.get('log_count_max','') }}" />
      </div>
      <!-- Existing Log Count Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="log_count_op" class="form-select">
          <option value="equal" {% if request.args.get('log_count_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('log_count_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('log_count_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('log_count_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('log_count_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="log_count" class="form-control" placeholder="Log Count" value="{{ request.args.get('log_count','') }}" />
      </div>
      <div class="col-md-2">
        <select name="status" class="form-select">
          <option value="">-- Status --</option>
          {% for s in statuses %}
            <option value="{{ s }}" {% if request.args.get('status','completed') == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="lack_of_accuracy" class="form-select">
          <option value="">-- Accuracy Issues --</option>
          <option value="true" {% if request.args.get('lack_of_accuracy','') == 'true' %}selected{% endif %}>True</option>
          <option value="false" {% if request.args.get('lack_of_accuracy','') == 'false' %}selected{% endif %}>False</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="tags" class="form-select">
          <option value="">-- Filter by Tag --</option>
          {% for tag in tags_for_dropdown %}
            <option value="{{ tag }}" {% if request.args.get('tags','') == tag %}selected{% endif %}>{{ tag }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Begin Segment Analysis Filters -->
<div class="row">
  <!-- Medium Segments Count (1-5km) -->
  <div class="col-md-2">
    <label for="medium_segments">Medium Segments (1-5km)</label>
    <select name="medium_segments_op" class="form-select">
      <option value="equal" {% if request.args.get('medium_segments_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('medium_segments_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('medium_segments_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('medium_segments_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('medium_segments_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="medium_segments" class="form-control" placeholder="Medium Segments" value="{{ request.args.get('medium_segments','') }}">
  </div>

  <!-- Long Segments Count (>5km) -->
  <div class="col-md-2">
    <label for="long_segments">Long Segments (>5km)</label>
    <select name="long_segments_op" class="form-select">
      <option value="equal" {% if request.args.get('long_segments_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('long_segments_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('long_segments_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('long_segments_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('long_segments_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="long_segments" class="form-control" placeholder="Long Segments" value="{{ request.args.get('long_segments','') }}">
  </div>

  <!-- Short Dist Total -->
  <div class="col-md-2">
    <label for="short_dist_total">Short Dist Total</label>
    <select name="short_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('short_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('short_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('short_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('short_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('short_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="short_dist_total" class="form-control" placeholder="Short Dist Total" value="{{ request.args.get('short_dist_total','') }}">
  </div>

  <!-- Medium Dist Total -->
  <div class="col-md-2">
    <label for="medium_dist_total">Medium Dist Total</label>
    <select name="medium_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('medium_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('medium_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('medium_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('medium_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('medium_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="medium_dist_total" class="form-control" placeholder="Medium Dist Total" value="{{ request.args.get('medium_dist_total','') }}">
  </div>

  <!-- Long Dist Total -->
  <div class="col-md-2">
    <label for="long_dist_total">Long Dist Total</label>
    <select name="long_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('long_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('long_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('long_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('long_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('long_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="long_dist_total" class="form-control" placeholder="Long Dist Total" value="{{ request.args.get('long_dist_total','') }}">
  </div>
</div>
<div class="row mt-2">
  <!-- Max Segment Distance -->
  <div class="col-md-2">
    <label for="max_segment_distance">Max Segment Dist</label>
    <select name="max_segment_distance_op" class="form-select">
      <option value="equal" {% if request.args.get('max_segment_distance_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('max_segment_distance_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('max_segment_distance_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('max_segment_distance_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('max_segment_distance_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="max_segment_distance" class="form-control" placeholder="Max Segment Dist" value="{{ request.args.get('max_segment_distance','') }}">
  </div>
  
  <!-- Avg Segment Distance -->
  <div class="col-md-2">
    <label for="avg_segment_distance">Avg Segment Dist</label>
    <select name="avg_segment_distance_op" class="form-select">
      <option value="equal" {% if request.args.get('avg_segment_distance_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('avg_segment_distance_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('avg_segment_distance_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('avg_segment_distance_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('avg_segment_distance_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="avg_segment_distance" class="form-control" placeholder="Avg Segment Dist" value="{{ request.args.get('avg_segment_distance','') }}">
  </div>
</div>
<!-- End Segment Analysis Filters -->

      <div class="col-md-2">
        <input type="text" name="export_name" class="form-control" placeholder="Export Name" value="{{ request.args.get('export_name','exported_trips') }}" />
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('export_trips', 
          trip_id=trip_id_search, 
          route_quality=route_quality_filter, 
          model=model_filter, 
          ram=ram_filter, 
          carrier=carrier_filter, 
          variance_min=variance_min, 
          variance_max=variance_max, 
          driver=driver_filter,
          trip_time_min=request.args.get('trip_time_min',''),
          trip_time_max=request.args.get('trip_time_max',''),
          trip_time_op=request.args.get('trip_time_op','equal'),
          trip_time=request.args.get('trip_time',''),
          completed_by=request.args.get('completed_by',''),
          log_count_min=request.args.get('log_count_min',''),
          log_count_max=request.args.get('log_count_max',''),
          log_count_op=request.args.get('log_count_op','equal'),
          log_count=request.args.get('log_count',''),
          status=request.args.get('status',''),
          lack_of_accuracy=request.args.get('lack_of_accuracy',''),
          tags=request.args.get('tags',''),
          export_name=request.args.get('export_name','exported_trips'),
          expected_trip_quality=request.args.get('expected_trip_quality',''),
          medium_segments=request.args.get('medium_segments',''),
          medium_segments_op=request.args.get('medium_segments_op','equal'),
          long_segments=request.args.get('long_segments',''),
          long_segments_op=request.args.get('long_segments_op','equal'),
          short_dist_total=request.args.get('short_dist_total',''),
          short_dist_total_op=request.args.get('short_dist_total_op','equal'),
          medium_dist_total=request.args.get('medium_dist_total',''),
          medium_dist_total_op=request.args.get('medium_dist_total_op','equal'),
          long_dist_total=request.args.get('long_dist_total',''),
          long_dist_total_op=request.args.get('long_dist_total_op','equal'),
          max_segment_distance=request.args.get('max_segment_distance',''),
          max_segment_distance_op=request.args.get('max_segment_distance_op','equal'),
          avg_segment_distance=request.args.get('avg_segment_distance',''),
          avg_segment_distance_op=request.args.get('avg_segment_distance_op','equal'),
          start_date=request.args.get('start_date',''),
          end_date=request.args.get('end_date','')
        ) }}" class="btn btn-success w-100">Export XLSX</a>
      </div>
    </form>
  </div>
  <div class="mb-3">
    <button id="update-db-btn" class="btn btn-warning">Update Database</button>
    <button id="add-new-tag-btn" class="btn btn-info">Add New Tag</button>
    <button id="delete-tag-btn" class="btn btn-danger">Delete Tag</button>
  </div>
  <div class="mb-3">
    <button id="full-update-btn" class="btn btn-danger">Full Refresh Excel Trips</button>
    <button id="update-all-tags-btn" class="btn btn-success" title="This will analyze log files for all trips and update their tags based on the analysis">Update Excel Trips Tags</button>
    <button id="request-driver-files-btn" class="btn btn-primary" title="Request driver files from March 3, 2025 till today">Request Driver Files</button>
  </div>
  <div id="driver-files-progress" class="alert alert-info" style="display:none;">
    <div class="d-flex align-items-center">
      <div class="spinner-border spinner-border-sm me-2" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <span>Requesting driver files... This may take a few minutes.</span>
    </div>
  </div>
  <div id="update-progress-container" style="display:none; margin-bottom: 15px;">
    <div class="progress" style="height: 25px;">
      <div id="update-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
    </div>
    <div class="mt-2 d-flex justify-content-between small fw-bold">
      <span id="progress-total">Total: 0</span>
      <span id="progress-completed">Completed: 0</span>
      <span id="progress-updated">Updated: 0</span>
      <span id="progress-skipped">Skipped: 0</span>
      <span id="progress-created">Created: 0</span>
      <span id="progress-errors">Errors: 0</span>
    </div>
    <div id="update-summary" class="mt-2 alert alert-info" style="display:none;"></div>
  </div>
</div>

<div class="card mb-4 animate__animated animate__fadeInUp">
  <div class="card-body table-container">
    <table class="table table-bordered custom-table">
      <thead class="table-light">

        <tr>
          
          <th>Driver</th>
          <th>Carrier</th>
          <th>Android Ver</th>
          <th>Model</th>
          <th>Device Name</th>
          <th>Chipset</th>
          <th>RAM</th>
          <th>Storage</th>
          <th>Background Tendency</th>
          <th>Manufacturer</th>
          <th>Manual Dist</th>
          <th>Calc Dist</th>
          <th>% Calc/Manual</th>
          <th>Variance (%)</th>
          <th>Trip ID</th>
          <th>Route Quality</th>
          <th>Expected Trip Quality</th>
          <th>Trip Time (h)</th>
          <th>Completed By</th>
          <th>Log Count</th>
          <th>Status</th>
          <th>Lack of Accuracy</th>
          <!-- Distance Analysis Columns -->
          <th>Short Segments (<1km)</th>
          <th>Medium Segments (1-5km)</th>
          <th>Long Segments (>5km)</th>
          <th>Short Dist Total</th>
          <th>Medium Dist Total</th>
          <th>Long Dist Total</th>
          <th>Max Segment Dist</th>
          <th>Avg Segment Dist</th>
          <th>Trip Issues</th>
          <th>Tags</th>
          <th>View Details</th>
          <th>Play Trip</th>
          <th>Log Analysis</th>
        </tr>
      </thead>
      <tbody>
        {% for trip in trips %}
        <tr>
          <td>{{ trip.UserName }}</td>
          <td>{{ trip.carrier }}</td>
          <td>{{ trip["Android Version"] }}</td>
          <td>{{ trip.model }}</td>
          <td>{{ trip["Device Name"] }}</td>
          <td>{{ trip.Chipset }}</td>
          <td>{{ trip.RAM }}</td>
          <td>{{ trip.Storage }}</td>
          <td>{{ trip["Background Task Killing Tendency"] }}</td>
          <td>{{ trip.manufacturer }}</td>
          <td>{{ trip.manual_distance }}</td>
          <td>{{ trip.calculated_distance }}</td>
          <td>{{ trip.distance_percentage }}</td>
          <td>
            {% if trip.variance is not none %}
              {{ trip.variance|round(2) }}%
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            <a href="https://backoffice.illa.blue/database/trips/{{ trip.tripId }}" target="_blank">{{ trip.tripId }}</a>
          </td>
          <td>
            <select class="form-select route-quality-select" data-trip-id="{{ trip.tripId }}">
              <option value="">-- Select --</option>
              <option value="No Logs Trips" {% if trip.route_quality == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
              <option value="Trip Points Only Exist" {% if trip.route_quality == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
              <option value="Low" {% if trip.route_quality == "Low" %}selected{% endif %}>Low</option>
              <option value="Moderate" {% if trip.route_quality == "Moderate" %}selected{% endif %}>Moderate</option>
              <option value="High" {% if trip.route_quality == "High" %}selected{% endif %}>High</option>
            </select>
          </td>
          <td>{{ trip.expected_trip_quality if trip.expected_trip_quality is not none else 'N/A' }}</td>
          <td>{{ trip.trip_time if trip.trip_time is not none else 'N/A' }}</td>
          <td>{{ trip.completed_by if trip.completed_by is not none else 'N/A' }}</td>
          <td>{{ trip.coordinate_count if trip.coordinate_count != "" else 'N/A' }}</td>
          <td>{{ trip.status if trip.status is not none else 'N/A' }}</td>
          <td>
            {{ trip.lack_of_accuracy if trip.lack_of_accuracy is not none else 'None' }}
          </td>
          <!-- Distance Analysis Data -->
          <td>{{ trip.short_segments_count if trip.short_segments_count is not none else '0' }}</td>
          <td>{{ trip.medium_segments_count if trip.medium_segments_count is not none else '0' }}</td>
          <td>{{ trip.long_segments_count if trip.long_segments_count is not none else '0' }}</td>
          <td>{% if trip.short_segments_distance is not none %}{{ trip.short_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.medium_segments_distance is not none %}{{ trip.medium_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.long_segments_distance is not none %}{{ trip.long_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.max_segment_distance is not none %}{{ trip.max_segment_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.avg_segment_distance is not none %}{{ trip.avg_segment_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>
            <button class="btn btn-primary btn-sm trip-issues-btn" data-trip-id="{{ trip.tripId }}" data-trip-issues="{{ trip.trip_issues|default('') }}">
              {% if trip.trip_issues and trip.trip_issues != '' %}
                Edit
              {% else %}
                Add
              {% endif %}
            </button>
          </td>
          <td>
            {% if trip.trip_issues %}
              {% for tag in trip.trip_issues.split(',') %}
                <span class="badge bg-success me-2 mb-2" data-bs-toggle="tooltip" data-bs-placement="top" title="This tag indicates a detected issue during the trip" style="cursor: help">{{ tag.strip() }}</span>
              {% endfor %}
            {% endif %}
          </td>
          <td>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('trip_detail', trip_id=trip.tripId) }}">View</a>
          </td>
          <td>
            <button class="btn btn-info btn-sm play-trip-btn" data-trip-id="{{ trip.tripId }}">Play Trip</button>
          </td>
          <td>
            <button class="btn btn-warning btn-sm analyze-logs-btn" data-trip-id="{{ trip.tripId }}">Analyze Logs</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <p class="mb-0">Showing page {{ page }} of {{ total_pages }} ({{ total_rows }} total rows)</p>
    <div>
      {% if page > 1 %}
        {% set prev_args = dict(request.args) %}
        {% set _ = prev_args.update({'page': page-1}) %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('trips', **prev_args) }}">
          Previous
        </a>
      {% endif %}
      {% if page < total_pages %}
        {% set next_args = dict(request.args) %}
        {% set _ = next_args.update({'page': page+1}) %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('trips', **next_args) }}">
          Next
        </a>
      {% endif %}
    </div>
  </div>
</div>
<script>
document.querySelectorAll('.route-quality-select').forEach(function(selectElem) {
  selectElem.addEventListener('change', function() {
    const tripId = this.getAttribute('data-trip-id');
    const selectedQuality = this.value;
    if (!selectedQuality) return;
    fetch('/update_route_quality', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: tripId, route_quality: selectedQuality })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Route quality updated for trip ' + tripId);
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while updating route quality.');
    });
  });
});

document.addEventListener('DOMContentLoaded', function() {
  // Add event listener for Update Excel Trips Tags button
  const requestDriverFilesBtn = document.getElementById('request-driver-files-btn');
  if (requestDriverFilesBtn) {
    requestDriverFilesBtn.addEventListener('click', function() {
      // Show password modal instead of immediately starting the request
      const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
      passwordModal.show();
    });
  }

  // Handle password submission
  const submitPasswordBtn = document.getElementById('submitPassword');
  if (submitPasswordBtn) {
    submitPasswordBtn.addEventListener('click', function() {
      const password = document.getElementById('requestPassword').value;
      const btn = document.getElementById('request-driver-files-btn');
      const progressDiv = document.getElementById('driver-files-progress');
      const passwordError = document.getElementById('passwordError');
      
      // Clear any previous error messages
      if (passwordError) passwordError.style.display = 'none';
      
      // Make the request to the backend with password
      fetch('{{ url_for("request_driver_files") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ password: password })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.message || 'Invalid password');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'error') {
          if (passwordError) {
            passwordError.textContent = data.message || 'Invalid password';
            passwordError.style.display = 'block';
          }
          return;
        }
        
        // Hide password modal and error
        const passwordModal = document.getElementById('passwordModal');
        if (passwordModal) {
          const bsModal = bootstrap.Modal.getInstance(passwordModal);
          if (bsModal) {
            bsModal.hide();
            // Remove modal backdrop
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
              backdrop.remove();
            }
            // Re-enable body scrolling
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
          }
        }
        if (passwordError) passwordError.style.display = 'none';
        const requestPassword = document.getElementById('requestPassword');
        if (requestPassword) requestPassword.value = '';
        
        // Continue with the original functionality
        if (data.status === 'started') {
          // Rest of the code remains the same...
          // ... existing code for progress handling ...
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (passwordError) {
          passwordError.textContent = error.message || 'An error occurred while requesting driver files';
          passwordError.style.display = 'block';
        }
      });
    });
  }

  // Clear password error when modal is hidden and ensure modal cleanup
  const passwordModal = document.getElementById('passwordModal');
  if (passwordModal) {
    passwordModal.addEventListener('hidden.bs.modal', function () {
      const passwordError = document.getElementById('passwordError');
      const requestPassword = document.getElementById('requestPassword');
      if (passwordError) passwordError.style.display = 'none';
      if (requestPassword) requestPassword.value = '';
      
      // Ensure modal backdrop is removed
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) {
        backdrop.remove();
      }
      // Re-enable body scrolling
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
    });
  }

  // Add event listener for logAnalysisModal close
  document.getElementById('logAnalysisModal').addEventListener('hidden.bs.modal', function () {
    // Remove backdrop manually if it persists
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
      backdrop.remove();
    }
    // Re-enable body scrolling
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
  });

  // Add event listener for Update Database button
  document.getElementById('update-db-btn').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;  // Disable button while processing
    
    // Show progress container
    const progressContainer = document.getElementById('update-progress-container');
    progressContainer.style.display = 'block';
    
    // Reset progress bar and stats
    const progressBar = document.getElementById('update-progress-bar');
    progressBar.style.width = '0%';
    progressBar.textContent = '0%';
    document.getElementById('progress-total').textContent = 'Total: 0';
    document.getElementById('progress-completed').textContent = 'Completed: 0';
    document.getElementById('progress-updated').textContent = 'Updated: 0';
    document.getElementById('progress-skipped').textContent = 'Skipped: 0';
    document.getElementById('progress-created').textContent = 'Created: 0';
    document.getElementById('progress-errors').textContent = 'Errors: 0';
    
    // Hide any previous summary
    const summaryDiv = document.getElementById('update-summary');
    summaryDiv.style.display = 'none';
    summaryDiv.textContent = '';
    
    // Start the update process
    fetch('/update_db_async', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'started') {
        // Start polling for progress
        const jobId = data.job_id;
        const pollInterval = setInterval(() => {
          fetch(`/update_progress?job_id=${jobId}`)
            .then(response => response.json())
            .then(status => {
              // Update progress bar and stats
              progressBar.style.width = status.percent + '%';
              progressBar.textContent = Math.round(status.percent) + '%';
              document.getElementById('progress-total').textContent = 'Total: ' + status.total;
              document.getElementById('progress-completed').textContent = 'Completed: ' + status.completed;
              document.getElementById('progress-updated').textContent = 'Updated: ' + status.updated;
              document.getElementById('progress-skipped').textContent = 'Skipped: ' + status.skipped;
              document.getElementById('progress-created').textContent = 'Created: ' + status.created;
              document.getElementById('progress-errors').textContent = 'Errors: ' + status.errors;
              
              // Check if process is complete
              if (status.status === 'completed' || status.status === 'error') {
                clearInterval(pollInterval);
                btn.disabled = false;  // Re-enable button
                
                if (status.status === 'completed') {
                  progressBar.classList.remove('progress-bar-animated');
                  if (status.summary) {
                    summaryDiv.textContent = status.summary;
                    summaryDiv.style.display = 'block';
                  }
                  // Reload the page after a short delay to show updated data
                  setTimeout(() => {
                    window.location.reload();
                  }, 3000);
                } else {
                  progressBar.classList.add('bg-danger');
                  summaryDiv.textContent = status.error_message || 'An error occurred during the update process';
                  summaryDiv.style.display = 'block';
                  summaryDiv.classList.remove('alert-info');
                  summaryDiv.classList.add('alert-danger');
                }
              }
            })
            .catch(error => {
              console.error('Error polling job status:', error);
              clearInterval(pollInterval);
              btn.disabled = false;  // Re-enable button
              summaryDiv.textContent = 'Error checking update progress';
              summaryDiv.style.display = 'block';
              summaryDiv.classList.remove('alert-info');
              summaryDiv.classList.add('alert-danger');
            });
        }, 1000); // Poll every second
      } else {
        btn.disabled = false;  // Re-enable button
        summaryDiv.textContent = 'Error starting update process: ' + (data.message || 'Unknown error');
        summaryDiv.style.display = 'block';
        summaryDiv.classList.remove('alert-info');
        summaryDiv.classList.add('alert-danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      btn.disabled = false;  // Re-enable button
      summaryDiv.textContent = 'Error starting update process';
      summaryDiv.style.display = 'block';
      summaryDiv.classList.remove('alert-info');
      summaryDiv.classList.add('alert-danger');
    });
  });
});

// Locate the full-update-btn event listener and update the modal code
document.addEventListener('DOMContentLoaded', function() {
  var fullUpdateBtn = document.getElementById('full-update-btn');
  if (fullUpdateBtn) {
    fullUpdateBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Show the in-page Bootstrap confirmation modal
      var modalEl = document.getElementById('confirmationModal');
      // Reparent the modal element to the document body if not already
      if (modalEl.parentNode !== document.body) {
        document.body.appendChild(modalEl);
      }
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
      
      // If user confirms, start the full refresh process
      document.getElementById('confirmFullRefresh').onclick = function() {
        modal.hide();
        fullUpdateBtn.disabled = true;
        fetch('{{ url_for("update_all_db_async") }}', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            var jobId = data.job_id;
            document.getElementById('update-progress-container').style.display = 'block';
            document.getElementById('update-summary').style.display = 'none';
            var progressBar = document.getElementById('update-progress-bar');
            var interval = setInterval(function() {
              fetch('{{ url_for("update_progress") }}' + '?job_id=' + jobId)
                .then(response => response.json())
                .then(progressData => {
                  if(progressData.error) {
                    clearInterval(interval);
                    alert('Error: ' + progressData.error);
                    document.getElementById('update-progress-container').style.display = 'none';
                    fullUpdateBtn.disabled = false;
                  } else {
                    var percent = progressData.percent;
                    progressBar.style.width = percent + '%';
                    progressBar.innerText = Math.floor(percent) + '%';
                    
                    // Update statistics counters
                    document.getElementById('progress-total').textContent = 'Total: ' + progressData.total;
                    document.getElementById('progress-completed').textContent = 'Completed: ' + progressData.completed;
                    document.getElementById('progress-updated').textContent = 'Updated: ' + progressData.updated;
                    document.getElementById('progress-skipped').textContent = 'Skipped: ' + progressData.skipped;
                    document.getElementById('progress-created').textContent = 'Created: ' + progressData.created;
                    document.getElementById('progress-errors').textContent = 'Errors: ' + progressData.errors;
                    
                    if(progressData.status === 'completed') {
                      clearInterval(interval);
                      
                      // Display summary information
                      var summaryDiv = document.getElementById('update-summary');
                      var summaryMessage = '';
                      
                      if (progressData.updated === 0) {
                          summaryMessage = 'All records are up to date! No updates needed.';
                      } else {
                          summaryMessage = 'Completed full update of ' + progressData.updated + ' out of ' + progressData.total + ' trips. ';
                          if (progressData.created > 0) {
                              summaryMessage += 'Created ' + progressData.created + ' new records. ';
                          }
                          summaryMessage += 'Skipped ' + progressData.skipped + ' records. ';
                          
                          if (progressData.errors > 0) {
                              summaryMessage += 'Encountered ' + progressData.errors + ' errors. ';
                          }
                          
                          if (progressData.summary_fields) {
                              summaryMessage += 'Most updated fields: ' + progressData.summary_fields.join(', ') + '.';
                          }
                          
                          if (progressData.summary_reasons) {
                              summaryMessage += ' Top reasons for updates: ' + progressData.summary_reasons.join(', ') + '.';
                          }
                      }
                      
                      summaryDiv.textContent = summaryMessage;
                      summaryDiv.style.display = 'block';
                      
                      setTimeout(function(){
                          fullUpdateBtn.disabled = false;
                      }, 1000);
                    }
                  }
                });
            }, 2000);
          });
      };

      // If user cancels, hide the modal
      document.getElementById('cancelFullRefresh').onclick = function() {
        modal.hide();
      };
    });
  }
});

// Add this at the end of your existing script
document.getElementById('filterForm').addEventListener('submit', function(event) {
  event.preventDefault();
  const formData = new FormData(this);
  const cleanedParams = new URLSearchParams();

  // Create a map of operator fields to their corresponding value fields
  const operatorPairs = {
    'trip_time_op': 'trip_time',
    'log_count_op': 'log_count',
    'medium_segments_op': 'medium_segments',
    'long_segments_op': 'long_segments',
    'short_dist_total_op': 'short_dist_total',
    'medium_dist_total_op': 'medium_dist_total',
    'long_dist_total_op': 'long_dist_total',
    'max_segment_distance_op': 'max_segment_distance',
    'avg_segment_distance_op': 'avg_segment_distance'
  };

  // First pass: collect all values
  const values = {};
  for (const [key, value] of formData.entries()) {
    values[key] = value.trim();
  }

  // Second pass: add only non-empty parameters to URL
  for (const [key, value] of formData.entries()) {
    const trimmedValue = value.trim();
    
    // Skip empty values and default values
    if (!trimmedValue) continue;
    if (key === 'export_name' && trimmedValue === 'exported_trips') continue;
    if (key === 'status' && trimmedValue === 'completed') continue;

    // Handle operator fields
    if (key.endsWith('_op')) {
      const valueField = operatorPairs[key];
      // Only include operator if it has a corresponding non-empty value
      if (values[valueField]) {
        if (trimmedValue !== 'equal') { // Only include non-default operators
          cleanedParams.append(key, trimmedValue);
        }
      }
    }
    // Handle regular fields
    else {
      // If this is a value field with an operator, only include it if it has a value
      if (Object.values(operatorPairs).includes(key)) {
        if (values[key]) {
          cleanedParams.append(key, trimmedValue);
        }
      }
      // For all other fields, include if they have a value
      else {
        cleanedParams.append(key, trimmedValue);
      }
    }
  }

  // Add page parameter if it exists and is not 1
  const urlParams = new URLSearchParams(window.location.search);
  const page = urlParams.get('page');
  if (page && page !== '1') {
    cleanedParams.append('page', page);
  }

  const queryString = cleanedParams.toString();
  window.location.href = '{{ url_for("trips") }}' + (queryString ? '?' + queryString : '');
  return false;
});

// Add event listener for Update Excel Trips Tags button
document.getElementById('update-all-tags-btn').addEventListener('click', function() {
  // Show progress container
  document.getElementById('update-progress-container').style.display = 'block';
  
  // Reset progress bar and stats
  document.getElementById('update-progress-bar').style.width = '0%';
  document.getElementById('update-progress-bar').textContent = '0%';
  document.getElementById('progress-total').textContent = 'Total: 0';
  document.getElementById('progress-completed').textContent = 'Completed: 0';
  document.getElementById('progress-updated').textContent = 'Updated: 0';
  document.getElementById('progress-skipped').textContent = 'Skipped: 0';
  document.getElementById('progress-errors').textContent = 'Errors: 0';
  
  // Start the update process
  fetch('/update_all_trips_tags', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.status === 'started') {
      // Start polling for progress
      const jobId = data.job_id;
      const pollInterval = setInterval(() => {
        fetch(`/job_status/${jobId}`)
          .then(response => response.json())
          .then(status => {
            // Update progress bar and stats
            document.getElementById('update-progress-bar').style.width = status.percent + '%';
            document.getElementById('update-progress-bar').textContent = Math.round(status.percent) + '%';
            document.getElementById('progress-total').textContent = 'Total: ' + status.total;
            document.getElementById('progress-completed').textContent = 'Completed: ' + status.completed;
            document.getElementById('progress-updated').textContent = 'Updated: ' + status.updated;
            document.getElementById('progress-skipped').textContent = 'Skipped: ' + status.skipped;
            document.getElementById('progress-errors').textContent = 'Errors: ' + status.errors;
            
            // Check if process is complete
            if (status.status === 'completed' || status.status === 'error') {
              clearInterval(pollInterval);
              if (status.status === 'completed') {
                alert('Tags update process completed successfully!');
              } else {
                alert('Error during tags update process: ' + status.error_message);
              }
            }
          })
          .catch(error => {
            console.error('Error polling job status:', error);
            clearInterval(pollInterval);
            alert('Error checking update progress');
          });
      }, 1000); // Poll every second
    } else {
      alert('Error starting tags update process: ' + data.message);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error starting tags update process');
  });
});

// Add event handler for Analyze Logs buttons
document.querySelectorAll('.analyze-logs-btn').forEach(function(btn) {
  btn.addEventListener('click', function() {
    const tripId = this.getAttribute('data-trip-id');
    document.getElementById('log-analysis-trip-id').textContent = tripId;
    
    // Reset modal content
    document.getElementById('log-analysis-loading').style.display = 'block';
    document.getElementById('log-analysis-error').style.display = 'none';
    document.getElementById('log-analysis-content').style.display = 'none';
    document.getElementById('log-issues-list').innerHTML = '';
    document.getElementById('log-tags-container').innerHTML = '';
    document.getElementById('log-issue-details').textContent = 'No details available';
    
    // Show the modal
    const logModal = new bootstrap.Modal(document.getElementById('logAnalysisModal'));
    logModal.show();
    
    // Fetch and analyze logs
    fetch('/download_driver_logs/' + tripId, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || 'Failed to download and analyze logs');
        });
      }
      return response.json();
    })
    .then(data => {
      // Hide loading, show content
      document.getElementById('log-analysis-loading').style.display = 'none';
      document.getElementById('log-analysis-content').style.display = 'block';
      
      // Fill in summary information
      document.getElementById('log-total-lines').textContent = data.analysis.total_lines;
      document.getElementById('log-time-range').textContent = 
        (data.analysis.first_timestamp || 'Unknown') + ' to ' + 
        (data.analysis.last_timestamp || 'Unknown');
      
      const timeWithoutLogs = data.analysis.time_without_logs;
      const minutes = Math.floor(timeWithoutLogs / 60);
      const seconds = Math.floor(timeWithoutLogs % 60);
      document.getElementById('log-time-without').textContent = 
        `${minutes} minutes, ${seconds} seconds`;
      
      document.getElementById('log-filename').textContent = data.filename;
      
      // Fill in issues list
      const issuesList = document.getElementById('log-issues-list');
      const issueItems = [
        { count: data.analysis.mqtt_connection_issues, label: 'MQTT Connection Issues' },
        { count: data.analysis.network_connectivity_issues, label: 'Network Connectivity Issues' },
        { count: data.analysis.location_tracking_issues, label: 'Location Tracking Issues' },
        { count: data.analysis.memory_pressure_indicators, label: 'Memory Pressure Indicators' },
        { count: data.analysis.app_crashes, label: 'App Crashes' },
        { count: data.analysis.server_errors, label: 'Server Errors' }
      ];
      
      issueItems.forEach(item => {
        if (item.count > 0) {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.textContent = item.label;
          const badge = document.createElement('span');
          badge.className = 'badge bg-primary rounded-pill';
          badge.textContent = item.count;
          li.appendChild(badge);
          issuesList.appendChild(li);
        }
      });
      
      // Fill in tags using the global tagDescriptions
      const tagsContainer = document.getElementById('log-tags-container');
      if (data.analysis.tags && data.analysis.tags.length > 0) {
        data.analysis.tags.forEach(tag => {
          const badge = document.createElement('span');
          badge.className = 'badge bg-success me-2 mb-2';
          badge.textContent = tag;
          badge.setAttribute('data-bs-toggle', 'tooltip');
          badge.setAttribute('data-bs-placement', 'top');
          badge.setAttribute('title', tagDescriptions[tag] || 'This tag indicates a detected issue during the trip');
          badge.style.cursor = 'help';
          tagsContainer.appendChild(badge);
        });
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(tagsContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
      } else {
        tagsContainer.textContent = 'No tags identified';
      }
      
      // Update the trip's tags in the table
      if (data.analysis.tags && data.analysis.tags.length > 0) {
        const tripRow = btn.closest('tr');
        const tagsCell = tripRow.querySelector('td:nth-child(32)');
        
        if (tagsCell) {
          tagsCell.innerHTML = '';
          let currentTags = new Set((tagsCell.getAttribute('data-current-tags') || '').split(',').map(t => t.trim()).filter(t => t));
          data.analysis.tags.forEach(tag => currentTags.add(tag));
          
          Array.from(currentTags).forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success me-2 mb-2';
            badge.textContent = tag;
            badge.setAttribute('data-bs-toggle', 'tooltip');
            badge.setAttribute('data-bs-placement', 'top');
            badge.setAttribute('title', tagDescriptions[tag] || 'This tag indicates a detected issue during the trip');
            badge.style.cursor = 'help';
            tagsCell.appendChild(badge);
          });
          
          tagsCell.setAttribute('data-current-tags', Array.from(currentTags).join(', '));
          
          const tooltipTriggerList = [].slice.call(tagsCell.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
          
          const issuesBtn = tripRow.querySelector('.trip-issues-btn');
          if (issuesBtn) {
            issuesBtn.textContent = 'Edit';
            issuesBtn.setAttribute('data-trip-issues', Array.from(currentTags).join(', '));
          }
        }
      }
      
      // Fill in issue details
      if (data.analysis.issue_details && data.analysis.issue_details.length > 0) {
        const detailsToShow = data.analysis.issue_details.slice(0, 100);
        const detailsText = detailsToShow.map(d => `[${d.type}] ${d.line}`).join('\n');
        document.getElementById('log-issue-details').textContent = detailsText;
        
        if (data.analysis.issue_details.length > 100) {
          document.getElementById('log-issue-details').textContent += 
            `\n\n... and ${data.analysis.issue_details.length - 100} more issues (not shown)`;
        }
      }
    })
    .catch(error => {
      document.getElementById('log-analysis-loading').style.display = 'none';
      const errorEl = document.getElementById('log-analysis-error');
      errorEl.style.display = 'block';
      errorEl.textContent = 'Error: ' + (error.message || 'Failed to analyze logs');
    });
  });
});

// Add this to your JavaScript section
document.getElementById('request-driver-files-btn').addEventListener('click', function() {
  // Show password modal instead of immediately starting the request
  const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
  passwordModal.show();
});

// Handle password submission
document.getElementById('submitPassword').addEventListener('click', function() {
  const password = document.getElementById('requestPassword').value;
  const btn = document.getElementById('request-driver-files-btn');
  const progressDiv = document.getElementById('driver-files-progress');
  const passwordError = document.getElementById('passwordError');
  
  // Clear any previous error messages
  passwordError.style.display = 'none';
  
  // Make the request to the backend with password
  fetch('{{ url_for("request_driver_files") }}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ password: password })
  })
  .then(response => {
    if (!response.ok) {
      return response.json().then(data => {
        throw new Error(data.message || 'Invalid password');
      });
    }
    return response.json();
  })
  .then(data => {
    if (data.status === 'error') {
      passwordError.textContent = data.message || 'Invalid password';
      passwordError.style.display = 'block';
      return;
    }
    
    // Hide password modal and error
    bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
    passwordError.style.display = 'none';
    document.getElementById('requestPassword').value = '';
    
    // Continue with the original functionality
    if (data.status === 'started') {
      // Disable button and show loading
      btn.disabled = true;
      progressDiv.style.display = 'block';
      progressDiv.innerHTML = `
        <div class="progress mb-2" style="height: 25px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
        </div>
        <div class="current-batch-info mt-2">
          <h6>Currently Processing:</h6>
          <div class="batch-messages" style="max-height: 200px; overflow-y: auto; font-size: 0.9em;">
          </div>
        </div>
        <div class="stats-info mt-2">
          <div class="row">
            <div class="col-md-4">
              <strong>Total Messages:</strong> <span class="total-messages">0</span>
            </div>
            <div class="col-md-4">
              <strong>Completed:</strong> <span class="completed-messages">0</span>
            </div>
            <div class="col-md-4">
              <strong>Errors:</strong> <span class="error-messages">0</span>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-md-12">
              <strong>Speed:</strong> <span class="messages-per-second">0</span> messages/sec
            </div>
          </div>
        </div>
      `;
      
      // Start polling for progress
      const jobId = data.job_id;
      const progressBar = progressDiv.querySelector('.progress-bar');
      const batchMessages = progressDiv.querySelector('.batch-messages');
      const totalMessages = progressDiv.querySelector('.total-messages');
      const completedMessages = progressDiv.querySelector('.completed-messages');
      const errorMessages = progressDiv.querySelector('.error-messages');
      const messagesPerSecond = progressDiv.querySelector('.messages-per-second');
      
      // Poll progress function
      const pollProgress = function() {
        fetch(`{{ url_for("driver_files_status", job_id="") }}${jobId}`)
          .then(response => response.json())
          .then(progress => {
            // Update progress bar
            const percent = progress.percent || 0;
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${Math.round(percent)}%`;
            
            // Update stats
            totalMessages.textContent = progress.total_messages ? progress.total_messages.toLocaleString() : '0';
            completedMessages.textContent = progress.completed ? progress.completed.toLocaleString() : '0';
            errorMessages.textContent = progress.errors ? progress.errors.toLocaleString() : '0';
            messagesPerSecond.textContent = progress.messages_per_second ? progress.messages_per_second.toFixed(1) : '0';
            
            // Update current batch info
            if (progress.current_batch && progress.current_batch.length > 0) {
              const batchHtml = progress.current_batch.map(msg => 
                `<div class="batch-message">
                  ${msg.driver_id ? 'Driver ' + msg.driver_id : 'Unknown Driver'} - 
                  ${msg.date || 'No Date'} - 
                  ${msg.topic || 'No Topic'}
                </div>`
              ).join('');
              batchMessages.innerHTML = batchHtml;
              
              // Auto-scroll to bottom
              batchMessages.scrollTop = batchMessages.scrollHeight;
            }
            
            // Check if complete
            if (progress.status === 'completed') {
              clearInterval(pollInterval);
              progressDiv.innerHTML = `
                <div class="alert alert-success">
                  ${progress.message || 'Process completed successfully!'}
                </div>
              `;
              btn.disabled = false;
            } else if (progress.status === 'error') {
              clearInterval(pollInterval);
              progressDiv.innerHTML = `
                <div class="alert alert-danger">
                  Error: ${progress.message || 'An error occurred during processing'}
                </div>
              `;
              btn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Error:', error);
            clearInterval(pollInterval);
            progressDiv.innerHTML = `
              <div class="alert alert-danger">
                An error occurred while checking progress.
              </div>
            `;
            btn.disabled = false;
          });
      };
      
      // Poll every 500ms
      const pollInterval = setInterval(pollProgress, 500);
      // Start polling immediately
      pollProgress();
    } else {
      // Show error message
      progressDiv.innerHTML = `
        <div class="alert alert-danger">
          Error: ${data.message || 'Failed to start the process'}
        </div>
      `;
      btn.disabled = false;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    passwordError.textContent = error.message || 'An error occurred while requesting driver files';
    passwordError.style.display = 'block';
  });
});

// Clear password error when modal is hidden
document.getElementById('passwordModal').addEventListener('hidden.bs.modal', function () {
  document.getElementById('passwordError').style.display = 'none';
  document.getElementById('requestPassword').value = '';
});

// ... rest of existing code ...
</script>

<!-- Confirmation Modal for Full Refresh -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true" style="z-index: 1100 !important;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Excel Trips Refresh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Warning: This will perform a full refresh from endpoints for all trips in the Excel file. This means all fields for these trips will be updated from the API, regardless of their current state. This process may take a long time. Do you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelFullRefresh">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmFullRefresh">Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- End of Confirmation Modal insertion -->

<!-- Play Trip Modal -->
<div class="modal fade" id="playTripModal" tabindex="-1" aria-labelledby="playTripModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:90%; margin:auto;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="playTripModalLabel">Trip Playback</h5>
        <button type="button" class="btn btn-secondary me-2" id="toggleFullscreenBtn" title="Toggle fullscreen mode">Fullscreen</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closePlayTripModal"></button>
      </div>
      <div class="modal-body">
        <div id="map" style="width:100%; height:400px;"></div>
        <!-- Playback Controls -->
        <div class="mt-3">
            <div class="btn-group" role="group" aria-label="Playback Controls">
                <button id="playStartBtn" class="btn btn-primary">Start</button>
                <button id="playPauseBtn" class="btn btn-secondary">Pause</button>
                <button id="playStopBtn" class="btn btn-danger">Stop</button>
                <button id="playStepBackBtn" class="btn btn-info">Step Backward</button>
                <button id="playStepForwardBtn" class="btn btn-info">Step Forward</button>
            </div>
            <div class="mt-2">
                <label for="playSeekBar">Progress: </label>
                <input type="range" id="playSeekBar" min="0" max="100" value="0" style="width: 50%;" />
                <span id="playProgressIndicator">0%</span>
            </div>
            <div class="mt-2">
                <label for="playSpeedSelect">Speed: </label>
                <select id="playSpeedSelect" title="Adjust playback speed in real time">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                    <option value="4">4x</option>
                    <option value="8">8x</option>
                    <option value="10">10x</option>
                    <option value="20">20x</option>
                </select>
                <label class="ms-3">
                    <input type="checkbox" id="reversePlayback" title="Toggle reverse playback direction"> Reverse Playback
                </label>
            </div>
            <!-- NEW: Polyline and Drawing Mode Controls -->
            <div class="mt-2">
                <label><input type="checkbox" id="togglePolyline" checked title="Display route as continuous polyline when checked; individual points when unchecked"> Show Polyline</label>
                <label class="ms-3">Drawing Mode: </label>
                <select id="drawingModeSelect" title="Choose drawing mode: Pre-drawn Mode shows full route upfront; Dynamic Drawing Mode draws the route incrementally">
                    <option value="predrawn" selected>Pre-drawn Mode</option>
                    <option value="dynamic">Dynamic Drawing Mode</option>
                </select>
            </div>
            <!-- End of NEW controls -->
        </div>
        <div id="playError" class="mt-3 text-danger" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


<!-- Playback Controls Script -->
<script>
    // Global variables for playback
    var playbackMap = null;
    var routePoints = [];
    var playbackMarker = null;
    var playbackTimer = null;
    var currentPointIndex = 0;
    var playbackSpeed = 1;
    var isPaused = false;
    var reversePlayback = false;
    // NEW: Variables for polyline and points mode
    var currentSegmentsPolyline = [];
    var pointsMarkers = [];

    function haversineDistance(coord1, coord2) {
        var lat1 = coord1[0] * Math.PI/180;
        var lon1 = coord1[1] * Math.PI/180;
        var lat2 = coord2[0] * Math.PI/180;
        var lon2 = coord2[1] * Math.PI/180;
        var dLat = lat2 - lat1;
        var dLon = lon2 - lon1;
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var R = 6371;
        return R * c;
    }

    // Function to update playback marker position and progress bar
    function updatePlaybackMarker(index) {
        if (playbackMarker && routePoints.length > index) {
            playbackMarker.setLatLng(routePoints[index]);
            if(playbackMap) {
                playbackMap.panTo(routePoints[index], {animate: true});
            }
        }
        var progress = Math.round((index / (routePoints.length - 1)) * 100);
        document.getElementById('playSeekBar').value = progress;
        document.getElementById('playProgressIndicator').innerText = progress + '%';
    }

    // ----------------------- Updated initMap -----------------------
    function initMap(coordinates) {
        if (playbackMap) {
            playbackMap.remove();
        }
        playbackMap = L.map('map').setView(coordinates[0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 19,
             attribution: ' OpenStreetMap'
        }).addTo(playbackMap);
        playbackMap.fitBounds(L.latLngBounds(coordinates), {padding: [50, 50]});
        // Add markers for start and end
        L.marker(coordinates[0], { icon: L.icon({ 
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })}).addTo(playbackMap);
        L.marker(coordinates[coordinates.length - 1], { icon: L.icon({ 
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })}).addTo(playbackMap);
        // Initialize route display based on user controls
        if(document.getElementById('togglePolyline').checked) {
             if(document.getElementById('drawingModeSelect').value === 'predrawn') {
                 currentSegmentsPolyline = [];
                 for (var i = 0; i < coordinates.length - 1; i++) {
                     var p0 = coordinates[i];
                     var p1 = coordinates[i+1];
                     var dist = haversineDistance(p0, p1);
                     var options = {};
                     if(dist > 5) { options = {color:'red', dashArray:'10,10', weight:5}; }
                     else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B', weight:5}; }
                     else { options = {color:'#1F7D53', weight:5}; }
                     var segment = L.polyline([p0, p1], options).addTo(playbackMap);
                     currentSegmentsPolyline.push(segment);
                 }
             } else {
                 currentSegmentsPolyline = [];
                 // Dynamic mode: segments will be added during playback
             }
        } else {
             pointsMarkers = [];
             coordinates.forEach(function(pt) {
                  var marker = L.marker(pt, {icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize:[12,12], iconAnchor:[6,6]})}).addTo(playbackMap);
                  pointsMarkers.push(marker);
             });
        }
        // Place playback marker at the start
        playbackMarker = L.marker(coordinates[0]).addTo(playbackMap);
    }

    // ----------------------- New: adjustMapSize Function -----------------------
    function adjustMapSize() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        var header = document.querySelector('#playTripModal .modal-header');
        var controls = document.querySelector('#playTripModal .mt-3');
        var availableHeight = modalContent.clientHeight - header.clientHeight - (controls ? controls.clientHeight : 0) - 30;
        document.getElementById('map').style.height = availableHeight + "px";
        if(playbackMap) playbackMap.invalidateSize();
    }

    // ----------------------- Updated Modal Event Listener -----------------------
    document.getElementById('playTripModal').addEventListener('shown.bs.modal', function () {
        adjustMapSize();
    });
    window.addEventListener('resize', adjustMapSize);

    // ----------------------- New: Playback Animation Functions -----------------------
    function startPlaybackAnimation() {
        playbackTimer = setInterval(function(){
            if (!isPaused) {
                if (reversePlayback) {
                    currentPointIndex--;
                    if (currentPointIndex < 0) {
                        stopPlayback();
                        return;
                    }
                } else {
                    currentPointIndex++;
                    if (currentPointIndex >= routePoints.length) {
                        stopPlayback();
                        return;
                    }
                }
                // Updated dynamic drawing mode: add a new segment with styled options based on distance
                if(document.getElementById('togglePolyline').checked && document.getElementById('drawingModeSelect').value === 'dynamic') {
                    if(currentPointIndex > 0) {
                        var p0 = routePoints[currentPointIndex - 1];
                        var p1 = routePoints[currentPointIndex];
                        var dist = haversineDistance(p0, p1);
                        var options = {};
                        if(dist > 5) { options = {color:'red', dashArray:'10,10'}; }
                        else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B'}; }
                        else { options = {color:'#1F7D53'}; }
                        var segment = L.polyline([p0, p1], options).addTo(playbackMap);
                        currentSegmentsPolyline.push(segment);
                    }
                }
                updatePlaybackMarker(currentPointIndex);
            }
        }, 1000 / playbackSpeed);
    }

    function startPlayback() {
        if (!routePoints.length) return;
        stopPlayback();
        isPaused = false;
        currentPointIndex = reversePlayback ? routePoints.length - 1 : 0;
        updatePlaybackMarker(currentPointIndex);
        startPlaybackAnimation();
    }

    function stopPlayback() {
        if (playbackTimer) {
            clearInterval(playbackTimer);
            playbackTimer = null;
        }
        // End-of-playback: marker remains at final coordinate based on playback direction
        currentPointIndex = reversePlayback ? 0 : routePoints.length - 1;
        updatePlaybackMarker(currentPointIndex);
    }

    // ----------------------- Updated: Speed Control Listener -----------------------
    document.getElementById('playSpeedSelect').addEventListener('change', function(){
        playbackSpeed = parseFloat(this.value);
        if(playbackTimer) {
           clearInterval(playbackTimer);
           startPlaybackAnimation();
        }
    });

    // Toggle Polyline Listener
    document.getElementById('togglePolyline').addEventListener('change', function() {
        if(playbackMap && routePoints && routePoints.length) {
            var showPolyline = this.checked;
            
            if(showPolyline) {
                var drawingMode = document.getElementById('drawingModeSelect').value;
                
                if(drawingMode === 'segmented') {
                    // Create segmented polylines
                    if(currentSegmentsPolyline && !Array.isArray(currentSegmentsPolyline)) {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                        currentSegmentsPolyline = null;
                    }
                    
                    if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                        currentSegmentsPolyline.forEach(function(seg) { 
                            playbackMap.removeLayer(seg); 
                        });
                    }
                    
                    // Create segmented view
                    currentSegmentsPolyline = [];
                    for(var i = 0; i < routePoints.length - 1; i++) {
                        var seg = L.polyline([routePoints[i], routePoints[i+1]], {color:'black', weight:5}).addTo(playbackMap);
                        currentSegmentsPolyline.push(seg);
                    }
                } else {
                    // Create continuous polyline
                    if(currentSegmentsPolyline && !Array.isArray(currentSegmentsPolyline)) {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                        currentSegmentsPolyline = L.polyline([routePoints[currentPointIndex]], {color:'blue', weight:5}).addTo(playbackMap);
                    } else {
                        if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                            currentSegmentsPolyline.forEach(function(seg) { 
                                playbackMap.removeLayer(seg); 
                            });
                        }
                        currentSegmentsPolyline = L.polyline([routePoints[currentPointIndex]], {color:'blue', weight:5}).addTo(playbackMap);
                    }
                }
            } else {
                // Remove polyline if exists and show individual markers
                if(currentSegmentsPolyline) {
                    if(Array.isArray(currentSegmentsPolyline)) {
                        currentSegmentsPolyline.forEach(function(seg) { 
                            playbackMap.removeLayer(seg); 
                        });
                    } else {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                    }
                    currentSegmentsPolyline = null;
                }
                if(pointsMarkers.length) {
                    pointsMarkers.forEach(function(marker){ 
                        playbackMap.removeLayer(marker); 
                    });
                    pointsMarkers = [];
                }
                routePoints.forEach(function(pt) {
                    var marker = L.marker(pt, {
                        icon: L.icon({
                            iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', 
                            iconSize:[12,12], 
                            iconAnchor:[6,6]
                        })
                    }).addTo(playbackMap);
                    pointsMarkers.push(marker);
                });
            }
        }
    });

    // ----------------------- New: Drawing Mode Option Listener -----------------------
    document.getElementById('drawingModeSelect').addEventListener('change', function() {
        var mode = this.value;
        var showPolyline = document.getElementById('togglePolyline').checked;
        if(playbackMap && routePoints && routePoints.length && showPolyline) {
             // Remove existing segmented layers
             if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                 currentSegmentsPolyline.forEach(function(seg) { playbackMap.removeLayer(seg); });
             }
             currentSegmentsPolyline = [];
             if(mode === 'predrawn') {
                  for (var i = 0; i < routePoints.length - 1; i++) {
                      var p0 = routePoints[i];
                      var p1 = routePoints[i+1];
                      var dist = haversineDistance(p0, p1);
                      var options = {};
                      if(dist > 5) { options = {color:'red', dashArray:'10,10', weight:5}; }
                      else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B', weight:5}; }
                      else { options = {color:'#1F7D53', weight:5}; }
                      var seg = L.polyline([p0, p1], options).addTo(playbackMap);
                      currentSegmentsPolyline.push(seg);
                  }
             } else {
                  // For dynamic mode, initialize with a starting segment in black
                  var seg = L.polyline([routePoints[currentPointIndex]], {color:'black', weight:5}).addTo(playbackMap);
                  currentSegmentsPolyline.push(seg);
             }
        }
    });

    // ----------------------- Updated: Fullscreen Toggle remains as-is -----------------------
    document.getElementById('toggleFullscreenBtn').addEventListener('click', function() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        if (!document.fullscreenElement) {
            modalContent.requestFullscreen().catch(err => {
                console.error('Error attempting to enable full-screen mode:', err);
            });
            this.innerText = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // Ensure that when the modal is hidden, we exit fullscreen mode
    document.getElementById('playTripModal').addEventListener('hide.bs.modal', function () {
        if (document.fullscreenElement) {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // New: Listen for fullscreen change and revert map size when exiting fullscreen
    document.addEventListener('fullscreenchange', function () {
        if (!document.fullscreenElement) {
            // Revert map container size to its default (400px) when not in fullscreen
            document.getElementById('map').style.height = '400px';
            if (playbackMap) playbackMap.invalidateSize();
        }
    });

    // Playback control event listeners
    document.getElementById('playStartBtn').addEventListener('click', function(){
         startPlayback();
    });
    document.getElementById('playPauseBtn').addEventListener('click', function(){
         if(isPaused) {
             isPaused = false;
             this.innerText = 'Pause';
         } else {
             isPaused = true;
             this.innerText = 'Resume';
         }
    });
    document.getElementById('playStopBtn').addEventListener('click', function(){
         stopPlayback();
         document.getElementById('playPauseBtn').innerText = 'Pause';
    });
    document.getElementById('playStepForwardBtn').addEventListener('click', function(){
         if(currentPointIndex < routePoints.length - 1) {
              currentPointIndex++;
              updatePlaybackMarker(currentPointIndex);
         }
    });
    document.getElementById('playStepBackBtn').addEventListener('click', function(){
         if(currentPointIndex > 0) {
              currentPointIndex--;
              updatePlaybackMarker(currentPointIndex);
         }
    });
    // New: Seek Bar Listener - update playback position when user moves the seek bar
    document.getElementById('playSeekBar').addEventListener('input', function() {
         var percent = parseInt(this.value, 10);
         currentPointIndex = Math.round((percent / 100) * (routePoints.length - 1));
         updatePlaybackMarker(currentPointIndex);
    });

    function loadTripCoordinates(tripId) {
        var modalEl = document.getElementById('playTripModal');
        var playModal = new bootstrap.Modal(modalEl);
        document.getElementById('playError').style.display = 'none';
        fetch('/trip_coordinates/' + tripId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API error');
                }
                return response.json();
            })
            .then(data => {
                var coords = data.data.attributes.coordinates;
                if (!coords || !coords.length) {
                    throw new Error('No coordinates found');
                }
                routePoints = coords.map(function(pair) {
                    return [parseFloat(pair[1]), parseFloat(pair[0])];
                });
                // If only one coordinate is returned, add a second coordinate for playback demo
                if(routePoints.length < 2) {
                    routePoints.push([routePoints[0][0] + 0.001, routePoints[0][1] + 0.001]);
                }
                modalEl.addEventListener('shown.bs.modal', function initMapAfterShow() {
                    initMap(routePoints);
                    currentPointIndex = reversePlayback ? routePoints.length - 1 : 0;
                    updatePlaybackMarker(currentPointIndex);
                    setTimeout(function() {
                        if (playbackMap) {
                            playbackMap.invalidateSize();
                        }
                    }, 100);
                }, { once: true });
                playModal.show();
            })
            .catch(error => {
                document.getElementById('playError').innerText = 'Error loading trip coordinates: ' + error;
                document.getElementById('playError').style.display = 'block';
            });
    }

    document.querySelectorAll('.play-trip-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            var tripId = this.getAttribute('data-trip-id');
            loadTripCoordinates(tripId);
        });
    });

    document.getElementById('playTripModal').addEventListener('hidden.bs.modal', function () {
        stopPlayback();
        if (playbackMap) {
            playbackMap.remove();
            playbackMap = null;
        }
    });

    // Append the modal to the document body on show to avoid stacking context issues
    document.addEventListener('show.bs.modal', function (event) {
        document.body.appendChild(event.target);
    });

    // Invalidate map size when the modal is fully shown to ensure the map renders correctly
    document.getElementById('playTripModal').addEventListener('shown.bs.modal', function () {
        if (playbackMap) {
            playbackMap.invalidateSize();
        }
    });

    // Fullscreen toggle functionality for playTripModal
    document.getElementById('toggleFullscreenBtn').addEventListener('click', function() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        if (!document.fullscreenElement) {
            modalContent.requestFullscreen().catch(err => {
                console.error('Error attempting to enable full-screen mode:', err);
            });
            this.innerText = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // Ensure that when the modal is hidden, we exit fullscreen mode
    document.getElementById('playTripModal').addEventListener('hide.bs.modal', function () {
        if (document.fullscreenElement) {
            document.exitFullscreen();
            document.getElementById('toggleFullscreenBtn').innerText = 'Fullscreen';
        }
    });
</script>

<!-- Trip Issues Modal -->
<div class="modal fade" id="tripIssuesModal" tabindex="-1" aria-labelledby="tripIssuesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tripIssuesModalLabel">Edit Trip Issues for Trip <span id="modal-trip-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select id="trip-issues-select" class="form-control" multiple style="width: 100%;"></select>
        <br>
        <button id="open-new-tag-modal" class="btn btn-link">Create New Tag</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-trip-issues-btn" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- New Tag Modal -->
<div class="modal fade" id="newTagModal" tabindex="-1" aria-labelledby="newTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTagModalLabel">Create New Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="new-tag-input" class="form-control" placeholder="Enter new tag name">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-new-tag-btn" class="btn btn-primary">Create Tag</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Tag Modal -->
<div class="modal fade" id="deleteTagModal" tabindex="-1" aria-labelledby="deleteTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTagModalLabel">Delete Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select id="delete-tag-select" class="form-control" style="width: 100%;"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-tag-btn" class="btn btn-danger">Delete Tag</button>
      </div>
    </div>
  </div>
</div>
<!-- Log Analysis Modal -->
<div class="modal fade" id="logAnalysisModal" tabindex="-1" aria-labelledby="logAnalysisModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="logAnalysisModalLabel">Log Analysis for Trip <span id="log-analysis-trip-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="log-analysis-loading" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Downloading and analyzing log files...</p>
        </div>
        <div id="log-analysis-error" class="alert alert-danger" style="display: none;"></div>
        <div id="log-analysis-content" style="display: none;">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">Log Summary</div>
                <div class="card-body">
                  <p><strong>Total Lines:</strong> <span id="log-total-lines"></span></p>
                  <p><strong>Time Range:</strong> <span id="log-time-range"></span></p>
                  <p><strong>Time Without Logs:</strong> <span id="log-time-without"></span></p>
                  <p><strong>Filename:</strong> <span id="log-filename"></span></p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">Issues Found</div>
                <div class="card-body">
                  <ul class="list-group" id="log-issues-list">
                  </ul>
                </div>
              </div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header">Tags Added</div>
            <div class="card-body">
              <div id="log-tags-container">
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">Issue Details</div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
              <pre id="log-issue-details" class="small">No details available</pre>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="passwordModalLabel">Enter Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <input type="password" class="form-control" id="requestPassword" placeholder="Enter password">
        </div>
        <div id="passwordError" class="alert alert-danger mt-2" style="display: none;">
          Incorrect password. Please try again.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submitPassword">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  // Initialize tooltips for table tags
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  let currentTripId = null;

  // When a Trip Issues button is clicked
  document.querySelectorAll('.trip-issues-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      currentTripId = this.getAttribute('data-trip-id');
      document.getElementById('modal-trip-id').textContent = currentTripId;
      // Open the modal (assumes Bootstrap 5)
      var tripModal = new bootstrap.Modal(document.getElementById('tripIssuesModal'));
      tripModal.show();

      // Populate the multi-select with all tags
      fetch('/get_tags')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('trip-issues-select');
          select.innerHTML = '';
          data.tags.forEach(tag => {
            let option = document.createElement('option');
            option.value = tag.name;
            option.text = tag.name;
            select.add(option);
          });
          // Preselect existing tags if any, from data attribute
          const existing = btn.getAttribute('data-trip-issues');
          if(existing){
            const tags = existing.split(',').map(t => t.trim()).filter(t => t);
            for(let opt of select.options){
              if(tags.includes(opt.value)){
                opt.selected = true;
              }
            }
          }
        });
    });
  });

  // Save changes for trip issues
  document.getElementById('save-trip-issues-btn').addEventListener('click', function(){
    const select = document.getElementById('trip-issues-select');
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    fetch('/update_trip_tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: currentTripId, tags: selected })
    })
    .then(response => response.json())
    .then(data => {
      if(data.status === 'success'){
        // Update the button text accordingly
        const issuesBtn = document.querySelector(`.trip-issues-btn[data-trip-id='${currentTripId}']`);
        issuesBtn.textContent = selected.length > 0 ? 'Edit' : 'Add';
        // Update its data attribute
        issuesBtn.setAttribute('data-trip-issues', selected.join(', '));
        
        // Update the tags cell with badges
        const tripRow = issuesBtn.closest('tr');
        const tagsCell = tripRow.querySelector('td:nth-child(32)'); // Updated index for tags column
        
        if (tagsCell) {
          // Clear existing content
          tagsCell.innerHTML = '';
          
          // Create badge for each selected tag
          selected.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success me-2 mb-2';
            badge.textContent = tag;
            badge.setAttribute('data-bs-toggle', 'tooltip');
            badge.setAttribute('data-bs-placement', 'top');
            badge.setAttribute('title', 'This tag indicates a detected issue during the trip');
            badge.style.cursor = 'help';
            tagsCell.appendChild(badge);
          });
          
          // Store current tags as data attribute
          tagsCell.setAttribute('data-current-tags', selected.join(', '));
          
          // Initialize tooltips for new badges
          const tooltipTriggerList = [].slice.call(tagsCell.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
        
        bootstrap.Modal.getInstance(document.getElementById('tripIssuesModal')).hide();
      } else {
        alert(data.message);
      }
    });
  });

  // Open New Tag Modal from within the Trip Issues Modal
  document.getElementById('open-new-tag-modal').addEventListener('click', function(){
    var newTagModal = new bootstrap.Modal(document.getElementById('newTagModal'));
    newTagModal.show();
  });

  // Handle Create New Tag
  document.getElementById('save-new-tag-btn').addEventListener('click', function(){
    const newTagName = document.getElementById('new-tag-input').value.trim();
    if(newTagName === ''){
      alert('Please enter a tag name');
      return;
    }
    fetch('/create_tag', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newTagName })
    })
    .then(response => response.json())
    .then(data => {
      if(data.status === 'success'){
        // Add the new tag to the multi-select dropdown
        const select = document.getElementById('trip-issues-select');
        let option = document.createElement('option');
        option.value = data.tag.name;
        option.text = data.tag.name;
        option.selected = true;
        select.add(option);
        document.getElementById('new-tag-input').value = '';
        bootstrap.Modal.getInstance(document.getElementById('newTagModal')).hide();
      } else {
        alert(data.message);
      }
    });
  });

  // 'Add New Tag' button outside the table opens the New Tag Modal
  document.getElementById('add-new-tag-btn').addEventListener('click', function(){
    var newTagModal = new bootstrap.Modal(document.getElementById('newTagModal'));
    newTagModal.show();
  });

  // Handle Delete Tag button click
  document.getElementById('delete-tag-btn').addEventListener('click', function(){
    // Populate the delete tag select with available tags
    fetch('/get_tags')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('delete-tag-select');
        select.innerHTML = '';
        data.tags.forEach(tag => {
          let option = document.createElement('option');
          option.value = tag.name;
          option.text = tag.name;
          select.add(option);
        });
        // Show the delete tag modal
        var deleteTagModal = new bootstrap.Modal(document.getElementById('deleteTagModal'));
        deleteTagModal.show();
      });
  });

  // Handle confirm delete tag
  document.getElementById('confirm-delete-tag-btn').addEventListener('click', function(){
    const select = document.getElementById('delete-tag-select');
    const tagName = select.value;
    if (!tagName) {
        alert('Please select a tag to delete.');
        return;
    }
    if (!confirm('Are you sure you want to delete the tag "' + tagName + '"? This action cannot be undone.')) {
        return;
    }
    fetch('/delete_tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: tagName})
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success'){
            alert('Tag deleted successfully.');
            bootstrap.Modal.getInstance(document.getElementById('deleteTagModal')).hide();
            // Remove deleted tag from trip issues select if present
            document.querySelectorAll('#trip-issues-select option').forEach(function(opt){
                if(opt.value === tagName) {
                    opt.remove();
                }
            });
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting tag: ' + error);
    });
  });

  // Handle analyze logs button click
  document.querySelectorAll('.analyze-logs-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      const tripId = this.getAttribute('data-trip-id');
      document.getElementById('log-analysis-trip-id').textContent = tripId;
      
      // Reset modal content
      document.getElementById('log-analysis-loading').style.display = 'block';
      document.getElementById('log-analysis-error').style.display = 'none';
      document.getElementById('log-analysis-content').style.display = 'none';
      document.getElementById('log-issues-list').innerHTML = '';
      document.getElementById('log-tags-container').innerHTML = '';
      document.getElementById('log-issue-details').textContent = 'No details available';
      
      // Show the modal
      const logModal = new bootstrap.Modal(document.getElementById('logAnalysisModal'));
      logModal.show();
      
      // Fetch and analyze logs
      fetch('/download_driver_logs/' + tripId, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.message || 'Failed to download and analyze logs');
          });
        }
        return response.json();
      })
      .then(data => {
        // Hide loading, show content
        document.getElementById('log-analysis-loading').style.display = 'none';
        document.getElementById('log-analysis-content').style.display = 'block';
        
        // Fill in summary information
        document.getElementById('log-total-lines').textContent = data.analysis.total_lines;
        document.getElementById('log-time-range').textContent = 
          (data.analysis.first_timestamp || 'Unknown') + ' to ' + 
          (data.analysis.last_timestamp || 'Unknown');
        
        const timeWithoutLogs = data.analysis.time_without_logs;
        const minutes = Math.floor(timeWithoutLogs / 60);
        const seconds = Math.floor(timeWithoutLogs % 60);
        document.getElementById('log-time-without').textContent = 
          `${minutes} minutes, ${seconds} seconds`;
        
        document.getElementById('log-filename').textContent = data.filename;
        
        // Fill in issues list
        const issuesList = document.getElementById('log-issues-list');
        const issueItems = [
          { count: data.analysis.mqtt_connection_issues, label: 'MQTT Connection Issues' },
          { count: data.analysis.network_connectivity_issues, label: 'Network Connectivity Issues' },
          { count: data.analysis.location_tracking_issues, label: 'Location Tracking Issues' },
          { count: data.analysis.memory_pressure_indicators, label: 'Memory Pressure Indicators' },
          { count: data.analysis.app_crashes, label: 'App Crashes' },
          { count: data.analysis.server_errors, label: 'Server Errors' }
        ];
        
        issueItems.forEach(item => {
          if (item.count > 0) {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.textContent = item.label;
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary rounded-pill';
            badge.textContent = item.count;
            li.appendChild(badge);
            issuesList.appendChild(li);
          }
        });
        
        // Fill in tags using the global tagDescriptions
        const tagsContainer = document.getElementById('log-tags-container');
        if (data.analysis.tags && data.analysis.tags.length > 0) {
          data.analysis.tags.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success me-2 mb-2';
            badge.textContent = tag;
            badge.setAttribute('data-bs-toggle', 'tooltip');
            badge.setAttribute('data-bs-placement', 'top');
            badge.setAttribute('title', tagDescriptions[tag] || 'This tag indicates a detected issue during the trip');
            badge.style.cursor = 'help';
            tagsContainer.appendChild(badge);
          });
          
          // Initialize tooltips
          const tooltipTriggerList = [].slice.call(tagsContainer.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        } else {
          tagsContainer.textContent = 'No tags identified';
        }
        
        // Update the trip's tags in the table
        if (data.analysis.tags && data.analysis.tags.length > 0) {
          const tripRow = btn.closest('tr');
          const tagsCell = tripRow.querySelector('td:nth-child(32)');
          
          if (tagsCell) {
            tagsCell.innerHTML = '';
            let currentTags = new Set((tagsCell.getAttribute('data-current-tags') || '').split(',').map(t => t.trim()).filter(t => t));
            data.analysis.tags.forEach(tag => currentTags.add(tag));
            
            Array.from(currentTags).forEach(tag => {
              const badge = document.createElement('span');
              badge.className = 'badge bg-success me-2 mb-2';
              badge.textContent = tag;
              badge.setAttribute('data-bs-toggle', 'tooltip');
              badge.setAttribute('data-bs-placement', 'top');
              badge.setAttribute('title', tagDescriptions[tag] || 'This tag indicates a detected issue during the trip');
              badge.style.cursor = 'help';
              tagsCell.appendChild(badge);
            });
            
            tagsCell.setAttribute('data-current-tags', Array.from(currentTags).join(', '));
            
            const tooltipTriggerList = [].slice.call(tagsCell.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
              return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            const issuesBtn = tripRow.querySelector('.trip-issues-btn');
            if (issuesBtn) {
              issuesBtn.textContent = 'Edit';
              issuesBtn.setAttribute('data-trip-issues', Array.from(currentTags).join(', '));
            }
          }
        }
        
        // Fill in issue details
        if (data.analysis.issue_details && data.analysis.issue_details.length > 0) {
          const detailsToShow = data.analysis.issue_details.slice(0, 100);
          const detailsText = detailsToShow.map(d => `[${d.type}] ${d.line}`).join('\n');
          document.getElementById('log-issue-details').textContent = detailsText;
          
          if (data.analysis.issue_details.length > 100) {
            document.getElementById('log-issue-details').textContent += 
              `\n\n... and ${data.analysis.issue_details.length - 100} more issues (not shown)`;
          }
        }
      })
      .catch(error => {
        document.getElementById('log-analysis-loading').style.display = 'none';
        const errorEl = document.getElementById('log-analysis-error');
        errorEl.style.display = 'block';
        errorEl.textContent = 'Error: ' + (error.message || 'Failed to analyze logs');
      });
    });
  });

  // Add event listener for Update Excel Trips Tags button
  document.getElementById('request-driver-files-btn').addEventListener('click', function() {
    // Show password modal instead of immediately starting the request
    const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
    passwordModal.show();
  });

  // Handle password submission
  document.getElementById('submitPassword').addEventListener('click', function() {
    const password = document.getElementById('requestPassword').value;
    const btn = document.getElementById('request-driver-files-btn');
    const progressDiv = document.getElementById('driver-files-progress');
    const passwordError = document.getElementById('passwordError');
    
    // Clear any previous error messages
    passwordError.style.display = 'none';
    
    // Make the request to the backend with password
    fetch('{{ url_for("request_driver_files") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ password: password })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || 'Invalid password');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.status === 'error') {
        passwordError.textContent = data.message || 'Invalid password';
        passwordError.style.display = 'block';
        return;
      }
      
      // Hide password modal and error
      bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
      passwordError.style.display = 'none';
      document.getElementById('requestPassword').value = '';
      
      // Continue with the original functionality
      if (data.status === 'started') {
        // Disable button and show loading
        btn.disabled = true;
        progressDiv.style.display = 'block';
        progressDiv.innerHTML = `
          <div class="progress mb-2" style="height: 25px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
          </div>
          <div class="current-batch-info mt-2">
            <h6>Currently Processing:</h6>
            <div class="batch-messages" style="max-height: 200px; overflow-y: auto; font-size: 0.9em;">
            </div>
          </div>
          <div class="stats-info mt-2">
            <div class="row">
              <div class="col-md-4">
                <strong>Total Messages:</strong> <span class="total-messages">0</span>
              </div>
              <div class="col-md-4">
                <strong>Completed:</strong> <span class="completed-messages">0</span>
              </div>
              <div class="col-md-4">
                <strong>Errors:</strong> <span class="error-messages">0</span>
              </div>
            </div>
            <div class="row mt-2">
              <div class="col-md-12">
                <strong>Speed:</strong> <span class="messages-per-second">0</span> messages/sec
              </div>
            </div>
          </div>
        `;
        
        // Start polling for progress
        const jobId = data.job_id;
        const progressBar = progressDiv.querySelector('.progress-bar');
        const batchMessages = progressDiv.querySelector('.batch-messages');
        const totalMessages = progressDiv.querySelector('.total-messages');
        const completedMessages = progressDiv.querySelector('.completed-messages');
        const errorMessages = progressDiv.querySelector('.error-messages');
        const messagesPerSecond = progressDiv.querySelector('.messages-per-second');
        
        // Poll progress function
        const pollProgress = function() {
          fetch(`{{ url_for("driver_files_status", job_id="") }}${jobId}`)
            .then(response => response.json())
            .then(progress => {
              // Update progress bar
              const percent = progress.percent || 0;
              progressBar.style.width = `${percent}%`;
              progressBar.textContent = `${Math.round(percent)}%`;
              
              // Update stats
              totalMessages.textContent = progress.total_messages ? progress.total_messages.toLocaleString() : '0';
              completedMessages.textContent = progress.completed ? progress.completed.toLocaleString() : '0';
              errorMessages.textContent = progress.errors ? progress.errors.toLocaleString() : '0';
              messagesPerSecond.textContent = progress.messages_per_second ? progress.messages_per_second.toFixed(1) : '0';
              
              // Update current batch info
              if (progress.current_batch && progress.current_batch.length > 0) {
                const batchHtml = progress.current_batch.map(msg => 
                  `<div class="batch-message">
                    ${msg.driver_id ? 'Driver ' + msg.driver_id : 'Unknown Driver'} - 
                    ${msg.date || 'No Date'} - 
                    ${msg.topic || 'No Topic'}
                  </div>`
                ).join('');
                batchMessages.innerHTML = batchHtml;
                
                // Auto-scroll to bottom
                batchMessages.scrollTop = batchMessages.scrollHeight;
              }
              
              // Check if complete
              if (progress.status === 'completed') {
                clearInterval(pollInterval);
                progressDiv.innerHTML = `
                  <div class="alert alert-success">
                    ${progress.message || 'Process completed successfully!'}
                  </div>
                `;
                btn.disabled = false;
              } else if (progress.status === 'error') {
                clearInterval(pollInterval);
                progressDiv.innerHTML = `
                  <div class="alert alert-danger">
                    Error: ${progress.message || 'An error occurred during processing'}
                  </div>
                `;
                btn.disabled = false;
              }
            })
            .catch(error => {
              console.error('Error:', error);
              clearInterval(pollInterval);
              progressDiv.innerHTML = `
                <div class="alert alert-danger">
                  An error occurred while checking progress.
                </div>
              `;
              btn.disabled = false;
            });
        };
        
        // Poll every 500ms
        const pollInterval = setInterval(pollProgress, 500);
        // Start polling immediately
        pollProgress();
      } else {
        // Show error message
        progressDiv.innerHTML = `
          <div class="alert alert-danger">
            Error: ${data.message || 'Failed to start the process'}
          </div>
        `;
        btn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Error:', error);
      passwordError.textContent = error.message || 'An error occurred while requesting driver files';
      passwordError.style.display = 'block';
    });
  });

  // Clear password error when modal is hidden
  document.getElementById('passwordModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('passwordError').style.display = 'none';
    document.getElementById('requestPassword').value = '';
  });
});

function cleanForm(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  const cleanedParams = new URLSearchParams();

  // Create a map of operator fields to their corresponding value fields
  const operatorPairs = {
    'trip_time_op': 'trip_time',
    'log_count_op': 'log_count',
    'medium_segments_op': 'medium_segments',
    'long_segments_op': 'long_segments',
    'short_dist_total_op': 'short_dist_total',
    'medium_dist_total_op': 'medium_dist_total',
    'long_dist_total_op': 'long_dist_total',
    'max_segment_distance_op': 'max_segment_distance',
    'avg_segment_distance_op': 'avg_segment_distance'
  };

  // First pass: collect all values
  const values = {};
  for (const [key, value] of formData.entries()) {
    values[key] = value.trim();
  }

  // Second pass: add only non-empty parameters to URL
  for (const [key, value] of formData.entries()) {
    const trimmedValue = value.trim();
    
    // Skip empty values and default values
    if (!trimmedValue) continue;
    if (key === 'export_name' && trimmedValue === 'exported_trips') continue;
    if (key === 'status' && trimmedValue === 'completed') continue;

    // Handle operator fields
    if (key.endsWith('_op')) {
      const valueField = operatorPairs[key];
      // Only include operator if it has a corresponding non-empty value
      if (values[valueField]) {
        if (trimmedValue !== 'equal') { // Only include non-default operators
          cleanedParams.append(key, trimmedValue);
        }
      }
    }
    // Handle regular fields
    else {
      const operatorField = key + '_op';
      // If this is a value field with an operator, only include it if it has a value
      if (Object.values(operatorPairs).includes(key)) {
        if (values[key]) {
          cleanedParams.append(key, trimmedValue);
        }
      }
      // For all other fields, include if they have a value
      else {
        cleanedParams.append(key, trimmedValue);
      }
    }
  }

  // Add page parameter if it exists and is not 1
  const urlParams = new URLSearchParams(window.location.search);
  const page = urlParams.get('page');
  if (page && page !== '1') {
    cleanedParams.append('page', page);
  }

  const queryString = cleanedParams.toString();
  window.location.href = `${form.action}${queryString ? '?' + queryString : ''}`;
  return false;
}

// Define tag descriptions globally so they can be used everywhere
const tagDescriptions = {
  'MQTT Connection Issues': 'The device experienced problems maintaining a stable connection to the MQTT server. This can result in delayed or missing real-time data transmission, affecting trip tracking accuracy and real-time monitoring capabilities.',
  'Network Connectivity Issues': 'The device encountered difficulties maintaining a reliable internet connection. This includes poor signal strength, network timeouts, or complete connection loss, which can impact data synchronization and real-time updates.',
  'Location Tracking Issues': 'The GPS or location services were not functioning optimally. This may include poor GPS accuracy, slow location fixes, or temporary loss of location tracking, affecting route accuracy.',
  'Memory Pressure': 'The device was experiencing memory constraints that could impact app performance. This includes situations where the system requested the app to reduce memory usage to prevent crashes.',
  'App Crashes': 'The application terminated unexpectedly during the trip. This includes both system-initiated terminations and app-level crashes, which can result in data loss or incomplete trip records.',
  'Server Errors': 'Communication with the server encountered errors. This includes failed API calls, timeout errors, or server-side issues that affected data synchronization and storage.',
  'High Battery Drain': 'The application consumed battery power at an above-normal rate. This may indicate intensive background processing, frequent GPS updates, or other power-intensive operations.',
  'Background Restrictions': 'The device\'s operating system restricted background processing. This can affect location tracking, data collection, and synchronization when the app is not in the foreground.',
  'GPS Signal Loss': 'The device experienced periods where GPS signal was weak or completely lost. This directly impacts route accuracy and may result in gaps in the trip recording.',
  'Data Gaps': 'Significant periods where no data was collected during the trip. This could be due to app suspension, network issues, or other technical problems affecting data collection.',
  'Slow Location Updates': 'Location data was being updated less frequently than expected. This can result in less accurate route tracking and distance calculations.',
  'Device Performance Issues': 'The device showed signs of general performance degradation. This includes slow response times, resource constraints, or system-level problems affecting app functionality.',
  'Critical Memory State': 'The device reached a critical memory state where the app was at risk of being terminated. This is the most severe level of memory pressure, requiring immediate resource release.',
  'System Memory Warning': 'The system indicated low memory conditions, requesting the app to reduce its memory usage. This is a preventive warning before reaching critical states.',
  'Battery Optimization Active': 'The device\'s battery optimization features were affecting app performance. This can result in reduced background processing and location update frequency.',
  'Multiple App Restarts': 'The app was restarted multiple times during the trip. This can indicate system resource management issues or app stability problems.',
  'Background Task Limitations': 'The system imposed restrictions on background tasks. This affects the app\'s ability to perform continuous tracking and data collection.',
  'Location Permission Issues': 'Problems were detected with location permission settings. This can affect the app\'s ability to access and record location data accurately.',
  'Sync Failures': 'Data synchronization with the server failed multiple times. This can result in delayed or missing trip data in the system.',
  'Hardware Limitations': 'The device\'s hardware capabilities limited optimal app performance. This includes insufficient RAM, CPU constraints, or sensor limitations.',
  'Critical Memory State - App at Risk of Termination': 'TRIM_MEMORY_COMPLETE: Most critical level, app is at high risk of being terminated, should free all non-critical resources immediately.',
  'System Critical Memory - Release Non-Essential Resources': 'TRIM_MEMORY_RUNNING_CRITICAL: Device is critically low on memory, app should release all non-essential resources to prevent termination.',
  'System Low Memory - Release Unused Resources': 'TRIM_MEMORY_RUNNING_LOW: Device is beginning to run low on memory, app should release unused resources to maintain stability.',
  'UI Hidden - Release UI Resources': 'TRIM_MEMORY_UI_HIDDEN: App UI is no longer visible, should release UI resources not needed when not visible to free up memory.',
  'Background State - Release Recreatable Resources': 'TRIM_MEMORY_BACKGROUND: App is in background, should release resources that can be easily recreated to help system stability.',
  'Moderate Memory Pressure - Consider Freeing Resources': 'TRIM_MEMORY_MODERATE: App is not in immediate danger but should free resources if possible to prevent future memory issues.',
  'System Moderate Memory - Check for Unused Resources': 'TRIM_MEMORY_RUNNING_MODERATE: Device is running moderately low on memory, active apps should check for and release unused resources.',
  'App Removed From Recents': 'The app was manually removed from recent apps list during the trip, which may affect background processing and data collection.',
  'Frequent Background Transitions': 'The app frequently moved between foreground and background states, which can impact tracking reliability and battery usage.',
  'Multiple App Sessions': 'The app was restarted multiple times during the trip, indicating potential stability or resource management issues.',
  'Location Sync Failures': 'Failed to synchronize location data with the server, resulting in potential gaps in trip tracking data.',
  'Significant Log Gaps': 'There were significant periods with no log entries, indicating potential tracking or app functionality issues.',
  'Battery Optimization Detected': 'System battery optimization features may have affected app performance and background processing capabilities.',
  'Normal Trip Termination': 'The trip ended normally with proper tracking termination, indicating a clean shutdown of tracking services.',
  'Killed by OS': 'The app process was terminated by the operating system, likely due to resource constraints or system policies.',
  'App Background Transitions': 'The app transitioned to background state during tracking, which may affect data collection accuracy.',
  'Successful Location Sync': 'Location data was successfully synchronized with the server, ensuring complete trip data recording.'
};

// Update the table tags with descriptions
document.addEventListener('DOMContentLoaded', function(){
  // Initialize tooltips for table tags
  document.querySelectorAll('.badge').forEach(function(badge) {
    const tagName = badge.textContent.trim();
    const description = tagDescriptions[tagName] || 'This tag indicates a detected issue during the trip';
    badge.setAttribute('title', description);
  });
  
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // ... rest of the existing code ...

  // Update the save trip issues function to use the descriptions
  document.getElementById('save-trip-issues-btn').addEventListener('click', function(){
    const select = document.getElementById('trip-issues-select');
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    fetch('/update_trip_tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: currentTripId, tags: selected })
    })
    .then(response => response.json())
    .then(data => {
      if(data.status === 'success'){
        const issuesBtn = document.querySelector(`.trip-issues-btn[data-trip-id='${currentTripId}']`);
        issuesBtn.textContent = selected.length > 0 ? 'Edit' : 'Add';
        issuesBtn.setAttribute('data-trip-issues', selected.join(', '));
        
        const tripRow = issuesBtn.closest('tr');
        const tagsCell = tripRow.querySelector('td:nth-child(32)');
        
        if (tagsCell) {
          tagsCell.innerHTML = '';
          
          selected.forEach(tag => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success me-2 mb-2';
            badge.textContent = tag;
            badge.setAttribute('data-bs-toggle', 'tooltip');
            badge.setAttribute('data-bs-placement', 'top');
            badge.setAttribute('title', tagDescriptions[tag] || 'This tag indicates a detected issue during the trip');
            badge.style.cursor = 'help';
            tagsCell.appendChild(badge);
          });
          
          tagsCell.setAttribute('data-current-tags', selected.join(', '));
          
          const tooltipTriggerList = [].slice.call(tagsCell.querySelectorAll('[data-bs-toggle="tooltip"]'));
          tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
          });
        }
        
        bootstrap.Modal.getInstance(document.getElementById('tripIssuesModal')).hide();
      } else {
        alert(data.message);
      }
    });
  });
});
// ... existing code ...
</script>
{% endblock %}
