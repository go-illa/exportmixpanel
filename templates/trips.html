{% extends "layout.html" %}
{% block content %}
<style>
  /* Ensure the table headers remain visible while scrolling horizontally */
  .table-container {
    width: 100%;
    overflow-x: auto;
  }
  .custom-table {
    min-width: 1800px;
    border-collapse: separate;
    border-spacing: 0;
  }
  .custom-table th,
  .custom-table td {
    white-space: nowrap;
    padding: 0.5rem;
    border: 1px solid #ddd;
  }
  /* Sticky header */
  .custom-table thead th {
    position: static;
    top: 0;
    background: #f8f9fa;
    z-index: 10;
  }
  /* Sticky first column (Trip ID) */
  .custom-table th:first-child,
  .custom-table td:first-child {
    position: static;
    left: 0;
    background: #f8f9fa;
    z-index: 11;
  }
</style>
<style>
  .modal {
    z-index: 1055 !important;
  }
  .modal-backdrop {
    z-index: 1050 !important;
  }

  .mt-4{
    
margin-left: 3%;
margin-right: 3%;
max-width: 100%;

  }

.container{
 width: 94%;
 }
</style>

<div class="card mb-4 animate__animated animate__fadeInUp" style="padding-left: 3%; padding-right: 3%;">
  <div class="card-body">
    <h2 class="card-title">Trips</h2>
    <form class="row g-3" method="GET" action="{{ url_for('trips') }}" id="filterForm">
      <div class="col-md-2">
        <input type="text" name="trip_id" class="form-control" placeholder="Trip ID" value="{{ trip_id_search }}" />
      </div>
      <div class="col-md-2">
        <select name="route_quality" class="form-select">
          <option value="">-- Route Quality --</option>
          <option value="Not Assigned" {% if route_quality_filter|lower == "not assigned" %}selected{% endif %}>Not Assigned</option>
          <option value="No Logs Trips" {% if route_quality_filter == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
          <option value="Trip Points Only Exist" {% if route_quality_filter == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
          <option value="Low" {% if route_quality_filter == "Low" %}selected{% endif %}>Low</option>
          <option value="Moderate" {% if route_quality_filter == "Moderate" %}selected{% endif %}>Moderate</option>
          <option value="High" {% if route_quality_filter == "High" %}selected{% endif %}>High</option>
        </select>
      </div>
      <!-- Expected Trip Quality Filter -->
<div class="col-md-2">
  <select name="expected_trip_quality" class="form-select">
    <option value="">-- Expected Trip Quality --</option>
    <option value="High Quality Trip" {% if expected_trip_quality_filter == "High Quality Trip" %}selected{% endif %}>High Quality Trip</option>
    <option value="Moderate Quality Trip" {% if expected_trip_quality_filter == "Moderate Quality Trip" %}selected{% endif %}>Moderate Quality Trip</option>
    <option value="Low Quality Trip" {% if expected_trip_quality_filter == "Low Quality Trip" %}selected{% endif %}>Low Quality Trip</option>
    <option value="No Logs Trip" {% if expected_trip_quality_filter == "No Logs Trip" %}selected{% endif %}>No Logs Trip</option>
    <option value="Trip Points Only Exist" {% if expected_trip_quality_filter == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
  </select>
</div>

      <div class="col-md-2">
        <select name="model" class="form-select">
          <option value="">-- Model --</option>
          {% for key, display in models_options %}
            <option value="{{ key }}" {% if model_filter == key %}selected{% endif %}>{{ display }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="ram" class="form-control" placeholder="RAM" value="{{ ram_filter }}" />
      </div>
      <div class="col-md-2">
        <select name="carrier" class="form-select">
          <option value="">-- Select Carrier --</option>
          {% for c in carriers_for_dropdown %}
          <option value="{{ c }}" {% if c == carrier_filter %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_min" class="form-control" placeholder="Variance Min (%)" value="{{ variance_min }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="variance_max" class="form-control" placeholder="Variance Max (%)" value="{{ variance_max }}" />
      </div>
      <div class="col-md-2">
        <select name="driver" class="form-select">
          <option value="">-- Select Driver --</option>
          {% for d in drivers %}
          <option value="{{ d }}" {% if d == driver_filter %}selected{% endif %}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- New Row: Trip Time Range -->
      <div class="col-md-2">
        <input type="text" name="trip_time_min" class="form-control" placeholder="Trip Time Min (h)" value="{{ request.args.get('trip_time_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="trip_time_max" class="form-control" placeholder="Trip Time Max (h)" value="{{ request.args.get('trip_time_max','') }}" />
      </div>
      <!-- Existing Trip Time Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="trip_time_op" class="form-select">
          <option value="equal" {% if request.args.get('trip_time_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('trip_time_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('trip_time_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('trip_time_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('trip_time_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="trip_time" class="form-control" placeholder="Trip Time (h)" value="{{ request.args.get('trip_time','') }}" />
      </div>
      <div class="col-md-2">
        <select name="completed_by" class="form-select">
          <option value="">-- Completed By --</option>
          {% for cb in completed_by_options %}
            <option value="{{ cb }}" {% if request.args.get('completed_by','') == cb %}selected{% endif %}>{{ cb }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- New Row: Log Count Range -->
      <div class="col-md-2">
        <input type="text" name="log_count_min" class="form-control" placeholder="Log Count Min" value="{{ request.args.get('log_count_min','') }}" />
      </div>
      <div class="col-md-2">
        <input type="text" name="log_count_max" class="form-control" placeholder="Log Count Max" value="{{ request.args.get('log_count_max','') }}" />
      </div>
      <!-- Existing Log Count Operator and Single Value Filter -->
      <div class="col-md-2">
        <select name="log_count_op" class="form-select">
          <option value="equal" {% if request.args.get('log_count_op','equal') == "equal" %}selected{% endif %}>equal</option>
          <option value="less than" {% if request.args.get('log_count_op','equal') == "less than" %}selected{% endif %}>less than</option>
          <option value="more than" {% if request.args.get('log_count_op','equal') == "more than" %}selected{% endif %}>more than</option>
          <option value="less than or equal" {% if request.args.get('log_count_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
          <option value="more than or equal" {% if request.args.get('log_count_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
        </select>
        <input type="text" name="log_count" class="form-control" placeholder="Log Count" value="{{ request.args.get('log_count','') }}" />
      </div>
      <div class="col-md-2">
        <select name="status" class="form-select">
          <option value="">-- Status --</option>
          {% for s in statuses %}
            <option value="{{ s }}" {% if request.args.get('status','completed') == s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="lack_of_accuracy" class="form-select">
          <option value="">-- Accuracy Issues --</option>
          <option value="true" {% if request.args.get('lack_of_accuracy','') == 'true' %}selected{% endif %}>True</option>
          <option value="false" {% if request.args.get('lack_of_accuracy','') == 'false' %}selected{% endif %}>False</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="tags" class="form-select">
          <option value="">-- Filter by Tag --</option>
          {% for tag in tags_for_dropdown %}
            <option value="{{ tag }}" {% if request.args.get('tags','') == tag %}selected{% endif %}>{{ tag }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Begin Segment Analysis Filters -->
<div class="row">
  <!-- Medium Segments Count (1-5km) -->
  <div class="col-md-2">
    <label for="medium_segments">Medium Segments (1-5km)</label>
    <select name="medium_segments_op" class="form-select">
      <option value="equal" {% if request.args.get('medium_segments_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('medium_segments_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('medium_segments_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('medium_segments_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('medium_segments_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="medium_segments" class="form-control" placeholder="Medium Segments" value="{{ request.args.get('medium_segments','') }}">
  </div>

  <!-- Long Segments Count (>5km) -->
  <div class="col-md-2">
    <label for="long_segments">Long Segments (>5km)</label>
    <select name="long_segments_op" class="form-select">
      <option value="equal" {% if request.args.get('long_segments_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('long_segments_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('long_segments_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('long_segments_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('long_segments_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="long_segments" class="form-control" placeholder="Long Segments" value="{{ request.args.get('long_segments','') }}">
  </div>

  <!-- Short Dist Total -->
  <div class="col-md-2">
    <label for="short_dist_total">Short Dist Total</label>
    <select name="short_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('short_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('short_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('short_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('short_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('short_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="short_dist_total" class="form-control" placeholder="Short Dist Total" value="{{ request.args.get('short_dist_total','') }}">
  </div>

  <!-- Medium Dist Total -->
  <div class="col-md-2">
    <label for="medium_dist_total">Medium Dist Total</label>
    <select name="medium_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('medium_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('medium_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('medium_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('medium_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('medium_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="medium_dist_total" class="form-control" placeholder="Medium Dist Total" value="{{ request.args.get('medium_dist_total','') }}">
  </div>

  <!-- Long Dist Total -->
  <div class="col-md-2">
    <label for="long_dist_total">Long Dist Total</label>
    <select name="long_dist_total_op" class="form-select">
      <option value="equal" {% if request.args.get('long_dist_total_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('long_dist_total_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('long_dist_total_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('long_dist_total_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('long_dist_total_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="long_dist_total" class="form-control" placeholder="Long Dist Total" value="{{ request.args.get('long_dist_total','') }}">
  </div>
</div>
<div class="row mt-2">
  <!-- Max Segment Distance -->
  <div class="col-md-2">
    <label for="max_segment_distance">Max Segment Dist</label>
    <select name="max_segment_distance_op" class="form-select">
      <option value="equal" {% if request.args.get('max_segment_distance_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('max_segment_distance_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('max_segment_distance_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('max_segment_distance_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('max_segment_distance_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="max_segment_distance" class="form-control" placeholder="Max Segment Dist" value="{{ request.args.get('max_segment_distance','') }}">
  </div>
  
  <!-- Avg Segment Distance -->
  <div class="col-md-2">
    <label for="avg_segment_distance">Avg Segment Dist</label>
    <select name="avg_segment_distance_op" class="form-select">
      <option value="equal" {% if request.args.get('avg_segment_distance_op','equal') == "equal" %}selected{% endif %}>equal</option>
      <option value="less than" {% if request.args.get('avg_segment_distance_op','equal') == "less than" %}selected{% endif %}>less than</option>
      <option value="more than" {% if request.args.get('avg_segment_distance_op','equal') == "more than" %}selected{% endif %}>more than</option>
      <option value="less than or equal" {% if request.args.get('avg_segment_distance_op','equal') == "less than or equal" %}selected{% endif %}>less than or equal</option>
      <option value="more than or equal" {% if request.args.get('avg_segment_distance_op','equal') == "more than or equal" %}selected{% endif %}>more than or equal</option>
    </select>
    <input type="text" name="avg_segment_distance" class="form-control" placeholder="Avg Segment Dist" value="{{ request.args.get('avg_segment_distance','') }}">
  </div>
</div>
<!-- End Segment Analysis Filters -->

      <div class="col-md-2">
        <input type="text" name="export_name" class="form-control" placeholder="Export Name" value="{{ request.args.get('export_name','exported_trips') }}" />
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100">Filter</button>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('export_trips', trip_id=trip_id_search, route_quality=route_quality_filter, model=model_filter, ram=ram_filter, carrier=carrier_filter, variance_min=variance_min, variance_max=variance_max, driver=driver_filter, trip_time_min=request.args.get('trip_time_min',''), trip_time_max=request.args.get('trip_time_max',''), trip_time_op=request.args.get('trip_time_op','equal'), trip_time=request.args.get('trip_time',''), completed_by=request.args.get('completed_by',''), log_count_min=request.args.get('log_count_min',''), log_count_max=request.args.get('log_count_max',''), log_count_op=request.args.get('log_count_op','equal'), log_count=request.args.get('log_count',''), status=request.args.get('status',''), lack_of_accuracy=request.args.get('lack_of_accuracy',''), tags=request.args.get('tags',''), export_name=request.args.get('export_name','exported_trips') ) }}" class="btn btn-success w-100">Export XLSX</a>
      </div>
    </form>
  </div>
  <div class="mb-3">
    <button id="update-db-btn" class="btn btn-warning">Update Database</button>
    <button id="add-new-tag-btn" class="btn btn-info">Add New Tag</button>
    <button id="delete-tag-btn" class="btn btn-danger">Delete Tag</button>
  </div>
  <div class="mb-3">
    <button id="full-update-btn" class="btn btn-danger">Full Refresh Excel Trips</button>
  </div>
  <div id="update-progress-container" style="display:none; margin-bottom: 15px;">
    <div class="progress" style="height: 25px;">
      <div id="update-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
    </div>
    <div class="mt-2 d-flex justify-content-between small fw-bold">
      <span id="progress-total">Total: 0</span>
      <span id="progress-completed">Completed: 0</span>
      <span id="progress-updated">Updated: 0</span>
      <span id="progress-skipped">Skipped: 0</span>
      <span id="progress-created">Created: 0</span>
      <span id="progress-errors">Errors: 0</span>
    </div>
    <div id="update-summary" class="mt-2 alert alert-info" style="display:none;"></div>
  </div>
</div>

<div class="card mb-4 animate__animated animate__fadeInUp">
  <div class="card-body table-container">
    <table class="table table-bordered custom-table">
      <thead class="table-light">

        <tr>
          
          <th>Driver</th>
          <th>Carrier</th>
          <th>Android Ver</th>
          <th>Model</th>
          <th>Device Name</th>
          <th>Chipset</th>
          <th>RAM</th>
          <th>Storage</th>
          <th>Background Tendency</th>
          <th>Manufacturer</th>
          <th>Manual Dist</th>
          <th>Calc Dist</th>
          <th>% Calc/Manual</th>
          <th>Variance (%)</th>
          <th>Trip ID</th>
          <th>Route Quality</th>
          <th>Expected Trip Quality</th>
          <th>Trip Time (h)</th>
          <th>Completed By</th>
          <th>Log Count</th>
          <th>Status</th>
          <th>Lack of Accuracy</th>
          <!-- Distance Analysis Columns -->
          <th>Short Segments (<1km)</th>
          <th>Medium Segments (1-5km)</th>
          <th>Long Segments (>5km)</th>
          <th>Short Dist Total</th>
          <th>Medium Dist Total</th>
          <th>Long Dist Total</th>
          <th>Max Segment Dist</th>
          <th>Avg Segment Dist</th>
          <th>Trip Issues</th>
          <th>Tags</th>
          <th>View Details</th>
          <th>Play Trip</th>
        </tr>
      </thead>
      <tbody>
        {% for trip in trips %}
        <tr>
          <td>{{ trip.UserName }}</td>
          <td>{{ trip.carrier }}</td>
          <td>{{ trip["Android Version"] }}</td>
          <td>{{ trip.model }}</td>
          <td>{{ trip["Device Name"] }}</td>
          <td>{{ trip.Chipset }}</td>
          <td>{{ trip.RAM }}</td>
          <td>{{ trip.Storage }}</td>
          <td>{{ trip["Background Task Killing Tendency"] }}</td>
          <td>{{ trip.manufacturer }}</td>
          <td>{{ trip.manual_distance }}</td>
          <td>{{ trip.calculated_distance }}</td>
          <td>{{ trip.distance_percentage }}</td>
          <td>
            {% if trip.variance is not none %}
              {{ trip.variance|round(2) }}%
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            <a href="https://backoffice.illa.blue/database/trips/{{ trip.tripId }}" target="_blank">{{ trip.tripId }}</a>
          </td>
          <td>
            <select class="form-select route-quality-select" data-trip-id="{{ trip.tripId }}">
              <option value="">-- Select --</option>
              <option value="No Logs Trips" {% if trip.route_quality == "No Logs Trips" %}selected{% endif %}>No Logs Trips</option>
              <option value="Trip Points Only Exist" {% if trip.route_quality == "Trip Points Only Exist" %}selected{% endif %}>Trip Points Only Exist</option>
              <option value="Low" {% if trip.route_quality == "Low" %}selected{% endif %}>Low</option>
              <option value="Moderate" {% if trip.route_quality == "Moderate" %}selected{% endif %}>Moderate</option>
              <option value="High" {% if trip.route_quality == "High" %}selected{% endif %}>High</option>
            </select>
          </td>
          <td>{{ trip.expected_trip_quality if trip.expected_trip_quality is not none else 'N/A' }}</td>
          <td>{{ trip.trip_time if trip.trip_time is not none else 'N/A' }}</td>
          <td>{{ trip.completed_by if trip.completed_by is not none else 'N/A' }}</td>
          <td>{{ trip.coordinate_count if trip.coordinate_count != "" else 'N/A' }}</td>
          <td>{{ trip.status if trip.status is not none else 'N/A' }}</td>
          <td>
            {{ trip.lack_of_accuracy if trip.lack_of_accuracy is not none else 'None' }}
          </td>
          <!-- Distance Analysis Data -->
          <td>{{ trip.short_segments_count if trip.short_segments_count is not none else '0' }}</td>
          <td>{{ trip.medium_segments_count if trip.medium_segments_count is not none else '0' }}</td>
          <td>{{ trip.long_segments_count if trip.long_segments_count is not none else '0' }}</td>
          <td>{% if trip.short_segments_distance is not none %}{{ trip.short_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.medium_segments_distance is not none %}{{ trip.medium_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.long_segments_distance is not none %}{{ trip.long_segments_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.max_segment_distance is not none %}{{ trip.max_segment_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>{% if trip.avg_segment_distance is not none %}{{ trip.avg_segment_distance|round(2) }} km{% else %}0.0 km{% endif %}</td>
          <td>
            <button class="btn btn-primary btn-sm trip-issues-btn" data-trip-id="{{ trip.tripId }}" data-trip-issues="{{ trip.trip_issues|default('') }}">
              {% if trip.trip_issues and trip.trip_issues != '' %}
                Edit
              {% else %}
                Add
              {% endif %}
            </button>
          </td>
          <td>
            {{ trip.trip_issues }}
          </td>
          <td>
            <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('trip_detail', trip_id=trip.tripId) }}">View</a>
          </td>
          <td>
            <button class="btn btn-info btn-sm play-trip-btn" data-trip-id="{{ trip.tripId }}">Play Trip</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-between align-items-center mt-3">
    <p class="mb-0">Showing page {{ page }} of {{ total_pages }} ({{ total_rows }} total rows)</p>
    <div>
      {% if page > 1 %}
        {% set prev_args = dict(request.args) %}
        {% set _ = prev_args.update({'page': page-1}) %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('trips', **prev_args) }}">
          Previous
        </a>
      {% endif %}
      {% if page < total_pages %}
        {% set next_args = dict(request.args) %}
        {% set _ = next_args.update({'page': page+1}) %}
        <a class="btn btn-secondary btn-sm" href="{{ url_for('trips', **next_args) }}">
          Next
        </a>
      {% endif %}
    </div>
  </div>
</div>
<script>
document.querySelectorAll('.route-quality-select').forEach(function(selectElem) {
  selectElem.addEventListener('change', function() {
    const tripId = this.getAttribute('data-trip-id');
    const selectedQuality = this.value;
    if (!selectedQuality) return;
    fetch('/update_route_quality', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: tripId, route_quality: selectedQuality })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        console.log('Route quality updated for trip ' + tripId);
      } else {
        alert('Error: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while updating route quality.');
    });
  });
});

document.getElementById('update-db-btn').addEventListener('click', function(e) {
  e.preventDefault();
  var btn = this;
  btn.disabled = true;
  fetch('{{ url_for("update_db_async") }}', { method: 'POST' })
    .then(response => response.json())
    .then(data => {
        var jobId = data.job_id;
        document.getElementById('update-progress-container').style.display = 'block';
        document.getElementById('update-summary').style.display = 'none';
        var progressBar = document.getElementById('update-progress-bar');
        var interval = setInterval(function() {
            fetch('{{ url_for("update_progress") }}' + '?job_id=' + jobId)
              .then(response => response.json())
              .then(progressData => {
                  if(progressData.error) {
                      clearInterval(interval);
                      alert('Error: ' + progressData.error);
                      document.getElementById('update-progress-container').style.display = 'none';
                      btn.disabled = false;
                  } else {
                      var percent = progressData.percent;
                      progressBar.style.width = percent + '%';
                      progressBar.innerText = Math.floor(percent) + '%';
                      
                      // Update statistics counters
                      document.getElementById('progress-total').textContent = 'Total: ' + progressData.total;
                      document.getElementById('progress-completed').textContent = 'Completed: ' + progressData.completed;
                      document.getElementById('progress-updated').textContent = 'Updated: ' + progressData.updated;
                      document.getElementById('progress-skipped').textContent = 'Skipped: ' + progressData.skipped;
                      document.getElementById('progress-created').textContent = 'Created: ' + progressData.created;
                      document.getElementById('progress-errors').textContent = 'Errors: ' + progressData.errors;
                      
                      if(progressData.status === 'completed') {
                          clearInterval(interval);
                          
                          // Display summary information
                          var summaryDiv = document.getElementById('update-summary');
                          var summaryMessage = '';
                          
                          if (progressData.updated === 0) {
                              summaryMessage = 'All records are up to date! No updates needed.';
                          } else {
                              summaryMessage = 'Updated ' + progressData.updated + ' out of ' + progressData.total + ' trips. ';
                              if (progressData.created > 0) {
                                  summaryMessage += 'Created ' + progressData.created + ' new records. ';
                              }
                              summaryMessage += 'Skipped ' + progressData.skipped + ' complete records. ';
                              
                              if (progressData.errors > 0) {
                                  summaryMessage += 'Encountered ' + progressData.errors + ' errors. ';
                              }
                              
                              if (progressData.summary_fields) {
                                  summaryMessage += 'Most updated fields: ' + progressData.summary_fields.join(', ') + '.';
                              }
                              
                              if (progressData.summary_reasons) {
                                  summaryMessage += ' Top reasons for updates: ' + progressData.summary_reasons.join(', ') + '.';
                              }
                          }
                          
                          summaryDiv.textContent = summaryMessage;
                          summaryDiv.style.display = 'block';
                          
                          setTimeout(function(){
                              btn.disabled = false;
                          }, 1000);
                      }
                  }
              });
        }, 2000);
    });
});

// Locate the full-update-btn event listener and update the modal code
document.addEventListener('DOMContentLoaded', function() {
  var fullUpdateBtn = document.getElementById('full-update-btn');
  if (fullUpdateBtn) {
    fullUpdateBtn.addEventListener('click', function(e) {
      e.preventDefault();
      // Show the in-page Bootstrap confirmation modal
      var modalEl = document.getElementById('confirmationModal');
      // Reparent the modal element to the document body if not already
      if (modalEl.parentNode !== document.body) {
        document.body.appendChild(modalEl);
      }
      var modal = new bootstrap.Modal(modalEl);
      modal.show();
      
      // If user confirms, start the full refresh process
      document.getElementById('confirmFullRefresh').onclick = function() {
        modal.hide();
        fullUpdateBtn.disabled = true;
        fetch('{{ url_for("update_all_db_async") }}', { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            var jobId = data.job_id;
            document.getElementById('update-progress-container').style.display = 'block';
            document.getElementById('update-summary').style.display = 'none';
            var progressBar = document.getElementById('update-progress-bar');
            var interval = setInterval(function() {
              fetch('{{ url_for("update_progress") }}' + '?job_id=' + jobId)
                .then(response => response.json())
                .then(progressData => {
                  if(progressData.error) {
                    clearInterval(interval);
                    alert('Error: ' + progressData.error);
                    document.getElementById('update-progress-container').style.display = 'none';
                    fullUpdateBtn.disabled = false;
                  } else {
                    var percent = progressData.percent;
                    progressBar.style.width = percent + '%';
                    progressBar.innerText = Math.floor(percent) + '%';
                    
                    // Update statistics counters
                    document.getElementById('progress-total').textContent = 'Total: ' + progressData.total;
                    document.getElementById('progress-completed').textContent = 'Completed: ' + progressData.completed;
                    document.getElementById('progress-updated').textContent = 'Updated: ' + progressData.updated;
                    document.getElementById('progress-skipped').textContent = 'Skipped: ' + progressData.skipped;
                    document.getElementById('progress-created').textContent = 'Created: ' + progressData.created;
                    document.getElementById('progress-errors').textContent = 'Errors: ' + progressData.errors;
                    
                    if(progressData.status === 'completed') {
                      clearInterval(interval);
                      
                      // Display summary information
                      var summaryDiv = document.getElementById('update-summary');
                      var summaryMessage = '';
                      
                      if (progressData.updated === 0) {
                          summaryMessage = 'All records are up to date! No updates needed.';
                      } else {
                          summaryMessage = 'Completed full update of ' + progressData.updated + ' out of ' + progressData.total + ' trips. ';
                          if (progressData.created > 0) {
                              summaryMessage += 'Created ' + progressData.created + ' new records. ';
                          }
                          summaryMessage += 'Skipped ' + progressData.skipped + ' records. ';
                          
                          if (progressData.errors > 0) {
                              summaryMessage += 'Encountered ' + progressData.errors + ' errors. ';
                          }
                          
                          if (progressData.summary_fields) {
                              summaryMessage += 'Most updated fields: ' + progressData.summary_fields.join(', ') + '.';
                          }
                          
                          if (progressData.summary_reasons) {
                              summaryMessage += ' Top reasons for updates: ' + progressData.summary_reasons.join(', ') + '.';
                          }
                      }
                      
                      summaryDiv.textContent = summaryMessage;
                      summaryDiv.style.display = 'block';
                      
                      setTimeout(function(){
                          fullUpdateBtn.disabled = false;
                      }, 1000);
                    }
                  }
                });
            }, 2000);
          });
      };

      // If user cancels, hide the modal
      document.getElementById('cancelFullRefresh').onclick = function() {
        modal.hide();
      };
    });
  }
});

// Add this at the end of your existing script
document.getElementById('filterForm').addEventListener('submit', function(event) {
  event.preventDefault();
  const formData = new FormData(this);
  const cleanedParams = new URLSearchParams();

  // Create a map of operator fields to their corresponding value fields
  const operatorPairs = {
    'trip_time_op': 'trip_time',
    'log_count_op': 'log_count',
    'medium_segments_op': 'medium_segments',
    'long_segments_op': 'long_segments',
    'short_dist_total_op': 'short_dist_total',
    'medium_dist_total_op': 'medium_dist_total',
    'long_dist_total_op': 'long_dist_total',
    'max_segment_distance_op': 'max_segment_distance',
    'avg_segment_distance_op': 'avg_segment_distance'
  };

  // First pass: collect all values
  const values = {};
  for (const [key, value] of formData.entries()) {
    values[key] = value.trim();
  }

  // Second pass: add only non-empty parameters to URL
  for (const [key, value] of formData.entries()) {
    const trimmedValue = value.trim();
    
    // Skip empty values and default values
    if (!trimmedValue) continue;
    if (key === 'export_name' && trimmedValue === 'exported_trips') continue;
    if (key === 'status' && trimmedValue === 'completed') continue;

    // Handle operator fields
    if (key.endsWith('_op')) {
      const valueField = operatorPairs[key];
      // Only include operator if it has a corresponding non-empty value
      if (values[valueField]) {
        if (trimmedValue !== 'equal') { // Only include non-default operators
          cleanedParams.append(key, trimmedValue);
        }
      }
    }
    // Handle regular fields
    else {
      // If this is a value field with an operator, only include it if it has a value
      if (Object.values(operatorPairs).includes(key)) {
        if (values[key]) {
          cleanedParams.append(key, trimmedValue);
        }
      }
      // For all other fields, include if they have a value
      else {
        cleanedParams.append(key, trimmedValue);
      }
    }
  }

  // Add page parameter if it exists and is not 1
  const urlParams = new URLSearchParams(window.location.search);
  const page = urlParams.get('page');
  if (page && page !== '1') {
    cleanedParams.append('page', page);
  }

  const queryString = cleanedParams.toString();
  window.location.href = '{{ url_for("trips") }}' + (queryString ? '?' + queryString : '');
  return false;
});
</script>

<!-- Confirmation Modal for Full Refresh -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true" style="z-index: 1100 !important;">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Excel Trips Refresh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Warning: This will perform a full refresh from endpoints for all trips in the Excel file. This means all fields for these trips will be updated from the API, regardless of their current state. This process may take a long time. Do you want to proceed?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelFullRefresh">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmFullRefresh">Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- End of Confirmation Modal insertion -->

<!-- Play Trip Modal -->
<div class="modal fade" id="playTripModal" tabindex="-1" aria-labelledby="playTripModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:90%; margin:auto;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="playTripModalLabel">Trip Playback</h5>
        <button type="button" class="btn btn-secondary me-2" id="toggleFullscreenBtn" title="Toggle fullscreen mode">Fullscreen</button>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closePlayTripModal"></button>
      </div>
      <div class="modal-body">
        <div id="map" style="width:100%; height:400px;"></div>
        <!-- Playback Controls -->
        <div class="mt-3">
            <div class="btn-group" role="group" aria-label="Playback Controls">
                <button id="playStartBtn" class="btn btn-primary">Start</button>
                <button id="playPauseBtn" class="btn btn-secondary">Pause</button>
                <button id="playStopBtn" class="btn btn-danger">Stop</button>
                <button id="playStepBackBtn" class="btn btn-info">Step Backward</button>
                <button id="playStepForwardBtn" class="btn btn-info">Step Forward</button>
            </div>
            <div class="mt-2">
                <label for="playSeekBar">Progress: </label>
                <input type="range" id="playSeekBar" min="0" max="100" value="0" style="width: 50%;" />
                <span id="playProgressIndicator">0%</span>
            </div>
            <div class="mt-2">
                <label for="playSpeedSelect">Speed: </label>
                <select id="playSpeedSelect" title="Adjust playback speed in real time">
                    <option value="0.5">0.5x</option>
                    <option value="1" selected>1x</option>
                    <option value="2">2x</option>
                    <option value="4">4x</option>
                    <option value="8">8x</option>
                    <option value="10">10x</option>
                    <option value="20">20x</option>
                </select>
                <label class="ms-3">
                    <input type="checkbox" id="reversePlayback" title="Toggle reverse playback direction"> Reverse Playback
                </label>
            </div>
            <!-- NEW: Polyline and Drawing Mode Controls -->
            <div class="mt-2">
                <label><input type="checkbox" id="togglePolyline" checked title="Display route as continuous polyline when checked; individual points when unchecked"> Show Polyline</label>
                <label class="ms-3">Drawing Mode: </label>
                <select id="drawingModeSelect" title="Choose drawing mode: Pre-drawn Mode shows full route upfront; Dynamic Drawing Mode draws the route incrementally">
                    <option value="predrawn" selected>Pre-drawn Mode</option>
                    <option value="dynamic">Dynamic Drawing Mode</option>
                </select>
            </div>
            <!-- End of NEW controls -->
        </div>
        <div id="playError" class="mt-3 text-danger" style="display:none;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


<!-- Playback Controls Script -->
<script>
    // Global variables for playback
    var playbackMap = null;
    var routePoints = [];
    var playbackMarker = null;
    var playbackTimer = null;
    var currentPointIndex = 0;
    var playbackSpeed = 1;
    var isPaused = false;
    var reversePlayback = false;
    // NEW: Variables for polyline and points mode
    var currentSegmentsPolyline = [];
    var pointsMarkers = [];

    function haversineDistance(coord1, coord2) {
        var lat1 = coord1[0] * Math.PI/180;
        var lon1 = coord1[1] * Math.PI/180;
        var lat2 = coord2[0] * Math.PI/180;
        var lon2 = coord2[1] * Math.PI/180;
        var dLat = lat2 - lat1;
        var dLon = lon2 - lon1;
        var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) * Math.sin(dLon/2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        var R = 6371;
        return R * c;
    }

    // Function to update playback marker position and progress bar
    function updatePlaybackMarker(index) {
        if (playbackMarker && routePoints.length > index) {
            playbackMarker.setLatLng(routePoints[index]);
            if(playbackMap) {
                playbackMap.panTo(routePoints[index], {animate: true});
            }
        }
        var progress = Math.round((index / (routePoints.length - 1)) * 100);
        document.getElementById('playSeekBar').value = progress;
        document.getElementById('playProgressIndicator').innerText = progress + '%';
    }

    // ----------------------- Updated initMap -----------------------
    function initMap(coordinates) {
        if (playbackMap) {
            playbackMap.remove();
        }
        playbackMap = L.map('map').setView(coordinates[0], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
             maxZoom: 19,
             attribution: 'Â© OpenStreetMap'
        }).addTo(playbackMap);
        playbackMap.fitBounds(L.latLngBounds(coordinates), {padding: [50, 50]});
        // Add markers for start and end
        L.marker(coordinates[0], { icon: L.icon({ 
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })}).addTo(playbackMap);
        L.marker(coordinates[coordinates.length - 1], { icon: L.icon({ 
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        })}).addTo(playbackMap);
        // Initialize route display based on user controls
        if(document.getElementById('togglePolyline').checked) {
             if(document.getElementById('drawingModeSelect').value === 'predrawn') {
                 currentSegmentsPolyline = [];
                 for (var i = 0; i < coordinates.length - 1; i++) {
                     var p0 = coordinates[i];
                     var p1 = coordinates[i+1];
                     var dist = haversineDistance(p0, p1);
                     var options = {};
                     if(dist > 5) { options = {color:'red', dashArray:'10,10', weight:5}; }
                     else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B', weight:5}; }
                     else { options = {color:'#1F7D53', weight:5}; }
                     var segment = L.polyline([p0, p1], options).addTo(playbackMap);
                     currentSegmentsPolyline.push(segment);
                 }
             } else {
                 currentSegmentsPolyline = [];
                 // Dynamic mode: segments will be added during playback
             }
        } else {
             pointsMarkers = [];
             coordinates.forEach(function(pt) {
                  var marker = L.marker(pt, {icon: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize:[12,12], iconAnchor:[6,6]})}).addTo(playbackMap);
                  pointsMarkers.push(marker);
             });
        }
        // Place playback marker at the start
        playbackMarker = L.marker(coordinates[0]).addTo(playbackMap);
    }

    // ----------------------- New: adjustMapSize Function -----------------------
    function adjustMapSize() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        var header = document.querySelector('#playTripModal .modal-header');
        var controls = document.querySelector('#playTripModal .mt-3');
        var availableHeight = modalContent.clientHeight - header.clientHeight - (controls ? controls.clientHeight : 0) - 30;
        document.getElementById('map').style.height = availableHeight + "px";
        if(playbackMap) playbackMap.invalidateSize();
    }

    // ----------------------- Updated Modal Event Listener -----------------------
    document.getElementById('playTripModal').addEventListener('shown.bs.modal', function () {
        adjustMapSize();
    });
    window.addEventListener('resize', adjustMapSize);

    // ----------------------- New: Playback Animation Functions -----------------------
    function startPlaybackAnimation() {
        playbackTimer = setInterval(function(){
            if (!isPaused) {
                if (reversePlayback) {
                    currentPointIndex--;
                    if (currentPointIndex < 0) {
                        stopPlayback();
                        return;
                    }
                } else {
                    currentPointIndex++;
                    if (currentPointIndex >= routePoints.length) {
                        stopPlayback();
                        return;
                    }
                }
                // Updated dynamic drawing mode: add a new segment with styled options based on distance
                if(document.getElementById('togglePolyline').checked && document.getElementById('drawingModeSelect').value === 'dynamic') {
                    if(currentPointIndex > 0) {
                        var p0 = routePoints[currentPointIndex - 1];
                        var p1 = routePoints[currentPointIndex];
                        var dist = haversineDistance(p0, p1);
                        var options = {};
                        if(dist > 5) { options = {color:'red', dashArray:'10,10'}; }
                        else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B'}; }
                        else { options = {color:'#1F7D53'}; }
                        var segment = L.polyline([p0, p1], options).addTo(playbackMap);
                        currentSegmentsPolyline.push(segment);
                    }
                }
                updatePlaybackMarker(currentPointIndex);
            }
        }, 1000 / playbackSpeed);
    }

    function startPlayback() {
        if (!routePoints.length) return;
        stopPlayback();
        isPaused = false;
        currentPointIndex = reversePlayback ? routePoints.length - 1 : 0;
        updatePlaybackMarker(currentPointIndex);
        startPlaybackAnimation();
    }

    function stopPlayback() {
        if (playbackTimer) {
            clearInterval(playbackTimer);
            playbackTimer = null;
        }
        // End-of-playback: marker remains at final coordinate based on playback direction
        currentPointIndex = reversePlayback ? 0 : routePoints.length - 1;
        updatePlaybackMarker(currentPointIndex);
    }

    // ----------------------- Updated: Speed Control Listener -----------------------
    document.getElementById('playSpeedSelect').addEventListener('change', function(){
        playbackSpeed = parseFloat(this.value);
        if(playbackTimer) {
           clearInterval(playbackTimer);
           startPlaybackAnimation();
        }
    });

    // Toggle Polyline Listener
    document.getElementById('togglePolyline').addEventListener('change', function() {
        if(playbackMap && routePoints && routePoints.length) {
            var showPolyline = this.checked;
            
            if(showPolyline) {
                var drawingMode = document.getElementById('drawingModeSelect').value;
                
                if(drawingMode === 'segmented') {
                    // Create segmented polylines
                    if(currentSegmentsPolyline && !Array.isArray(currentSegmentsPolyline)) {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                        currentSegmentsPolyline = null;
                    }
                    
                    if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                        currentSegmentsPolyline.forEach(function(seg) { 
                            playbackMap.removeLayer(seg); 
                        });
                    }
                    
                    // Create segmented view
                    currentSegmentsPolyline = [];
                    for(var i = 0; i < routePoints.length - 1; i++) {
                        var seg = L.polyline([routePoints[i], routePoints[i+1]], {color:'black', weight:5}).addTo(playbackMap);
                        currentSegmentsPolyline.push(seg);
                    }
                } else {
                    // Create continuous polyline
                    if(currentSegmentsPolyline && !Array.isArray(currentSegmentsPolyline)) {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                        currentSegmentsPolyline = L.polyline([routePoints[currentPointIndex]], {color:'blue', weight:5}).addTo(playbackMap);
                    } else {
                        if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                            currentSegmentsPolyline.forEach(function(seg) { 
                                playbackMap.removeLayer(seg); 
                            });
                        }
                        currentSegmentsPolyline = L.polyline([routePoints[currentPointIndex]], {color:'blue', weight:5}).addTo(playbackMap);
                    }
                }
            } else {
                // Remove polyline if exists and show individual markers
                if(currentSegmentsPolyline) {
                    if(Array.isArray(currentSegmentsPolyline)) {
                        currentSegmentsPolyline.forEach(function(seg) { 
                            playbackMap.removeLayer(seg); 
                        });
                    } else {
                        playbackMap.removeLayer(currentSegmentsPolyline);
                    }
                    currentSegmentsPolyline = null;
                }
                if(pointsMarkers.length) {
                    pointsMarkers.forEach(function(marker){ 
                        playbackMap.removeLayer(marker); 
                    });
                    pointsMarkers = [];
                }
                routePoints.forEach(function(pt) {
                    var marker = L.marker(pt, {
                        icon: L.icon({
                            iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', 
                            iconSize:[12,12], 
                            iconAnchor:[6,6]
                        })
                    }).addTo(playbackMap);
                    pointsMarkers.push(marker);
                });
            }
        }
    });

    // ----------------------- New: Drawing Mode Option Listener -----------------------
    document.getElementById('drawingModeSelect').addEventListener('change', function() {
        var mode = this.value;
        var showPolyline = document.getElementById('togglePolyline').checked;
        if(playbackMap && routePoints && routePoints.length && showPolyline) {
             // Remove existing segmented layers
             if(currentSegmentsPolyline && Array.isArray(currentSegmentsPolyline)) {
                 currentSegmentsPolyline.forEach(function(seg) { playbackMap.removeLayer(seg); });
             }
             currentSegmentsPolyline = [];
             if(mode === 'predrawn') {
                  for (var i = 0; i < routePoints.length - 1; i++) {
                      var p0 = routePoints[i];
                      var p1 = routePoints[i+1];
                      var dist = haversineDistance(p0, p1);
                      var options = {};
                      if(dist > 5) { options = {color:'red', dashArray:'10,10', weight:5}; }
                      else if(dist >= 1 && dist <= 5) { options = {color:'#2D336B', weight:5}; }
                      else { options = {color:'#1F7D53', weight:5}; }
                      var seg = L.polyline([p0, p1], options).addTo(playbackMap);
                      currentSegmentsPolyline.push(seg);
                  }
             } else {
                  // For dynamic mode, initialize with a starting segment in black
                  var seg = L.polyline([routePoints[currentPointIndex]], {color:'black', weight:5}).addTo(playbackMap);
                  currentSegmentsPolyline.push(seg);
             }
        }
    });

    // ----------------------- Updated: Fullscreen Toggle remains as-is -----------------------
    document.getElementById('toggleFullscreenBtn').addEventListener('click', function() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        if (!document.fullscreenElement) {
            modalContent.requestFullscreen().catch(err => {
                console.error('Error attempting to enable full-screen mode:', err);
            });
            this.innerText = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // Ensure that when the modal is hidden, we exit fullscreen mode
    document.getElementById('playTripModal').addEventListener('hide.bs.modal', function () {
        if (document.fullscreenElement) {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // New: Listen for fullscreen change and revert map size when exiting fullscreen
    document.addEventListener('fullscreenchange', function () {
        if (!document.fullscreenElement) {
            // Revert map container size to its default (400px) when not in fullscreen
            document.getElementById('map').style.height = '400px';
            if (playbackMap) playbackMap.invalidateSize();
        }
    });

    // Playback control event listeners
    document.getElementById('playStartBtn').addEventListener('click', function(){
         startPlayback();
    });
    document.getElementById('playPauseBtn').addEventListener('click', function(){
         if(isPaused) {
             isPaused = false;
             this.innerText = 'Pause';
         } else {
             isPaused = true;
             this.innerText = 'Resume';
         }
    });
    document.getElementById('playStopBtn').addEventListener('click', function(){
         stopPlayback();
         document.getElementById('playPauseBtn').innerText = 'Pause';
    });
    document.getElementById('playStepForwardBtn').addEventListener('click', function(){
         if(currentPointIndex < routePoints.length - 1) {
              currentPointIndex++;
              updatePlaybackMarker(currentPointIndex);
         }
    });
    document.getElementById('playStepBackBtn').addEventListener('click', function(){
         if(currentPointIndex > 0) {
              currentPointIndex--;
              updatePlaybackMarker(currentPointIndex);
         }
    });
    // New: Seek Bar Listener - update playback position when user moves the seek bar
    document.getElementById('playSeekBar').addEventListener('input', function() {
         var percent = parseInt(this.value, 10);
         currentPointIndex = Math.round((percent / 100) * (routePoints.length - 1));
         updatePlaybackMarker(currentPointIndex);
    });

    function loadTripCoordinates(tripId) {
        var modalEl = document.getElementById('playTripModal');
        var playModal = new bootstrap.Modal(modalEl);
        document.getElementById('playError').style.display = 'none';
        fetch('/trip_coordinates/' + tripId)
            .then(response => {
                if (!response.ok) {
                    throw new Error('API error');
                }
                return response.json();
            })
            .then(data => {
                var coords = data.data.attributes.coordinates;
                if (!coords || !coords.length) {
                    throw new Error('No coordinates found');
                }
                routePoints = coords.map(function(pair) {
                    return [parseFloat(pair[1]), parseFloat(pair[0])];
                });
                // If only one coordinate is returned, add a second coordinate for playback demo
                if(routePoints.length < 2) {
                    routePoints.push([routePoints[0][0] + 0.001, routePoints[0][1] + 0.001]);
                }
                modalEl.addEventListener('shown.bs.modal', function initMapAfterShow() {
                    initMap(routePoints);
                    currentPointIndex = reversePlayback ? routePoints.length - 1 : 0;
                    updatePlaybackMarker(currentPointIndex);
                    setTimeout(function() {
                        if (playbackMap) {
                            playbackMap.invalidateSize();
                        }
                    }, 100);
                }, { once: true });
                playModal.show();
            })
            .catch(error => {
                document.getElementById('playError').innerText = 'Error loading trip coordinates: ' + error;
                document.getElementById('playError').style.display = 'block';
            });
    }

    document.querySelectorAll('.play-trip-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
            var tripId = this.getAttribute('data-trip-id');
            loadTripCoordinates(tripId);
        });
    });

    document.getElementById('playTripModal').addEventListener('hidden.bs.modal', function () {
        stopPlayback();
        if (playbackMap) {
            playbackMap.remove();
            playbackMap = null;
        }
    });

    // Append the modal to the document body on show to avoid stacking context issues
    document.addEventListener('show.bs.modal', function (event) {
        document.body.appendChild(event.target);
    });

    // Invalidate map size when the modal is fully shown to ensure the map renders correctly
    document.getElementById('playTripModal').addEventListener('shown.bs.modal', function () {
        if (playbackMap) {
            playbackMap.invalidateSize();
        }
    });

    // Fullscreen toggle functionality for playTripModal
    document.getElementById('toggleFullscreenBtn').addEventListener('click', function() {
        var modalContent = document.querySelector('#playTripModal .modal-content');
        if (!document.fullscreenElement) {
            modalContent.requestFullscreen().catch(err => {
                console.error('Error attempting to enable full-screen mode:', err);
            });
            this.innerText = 'Exit Fullscreen';
        } else {
            document.exitFullscreen();
            this.innerText = 'Fullscreen';
        }
    });

    // Ensure that when the modal is hidden, we exit fullscreen mode
    document.getElementById('playTripModal').addEventListener('hide.bs.modal', function () {
        if (document.fullscreenElement) {
            document.exitFullscreen();
            document.getElementById('toggleFullscreenBtn').innerText = 'Fullscreen';
        }
    });
</script>

<!-- Trip Issues Modal -->
<div class="modal fade" id="tripIssuesModal" tabindex="-1" aria-labelledby="tripIssuesModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="tripIssuesModalLabel">Edit Trip Issues for Trip <span id="modal-trip-id"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select id="trip-issues-select" class="form-control" multiple style="width: 100%;"></select>
        <br>
        <button id="open-new-tag-modal" class="btn btn-link">Create New Tag</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-trip-issues-btn" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>

<!-- New Tag Modal -->
<div class="modal fade" id="newTagModal" tabindex="-1" aria-labelledby="newTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTagModalLabel">Create New Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="new-tag-input" class="form-control" placeholder="Enter new tag name">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="save-new-tag-btn" class="btn btn-primary">Create Tag</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Tag Modal -->
<div class="modal fade" id="deleteTagModal" tabindex="-1" aria-labelledby="deleteTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTagModalLabel">Delete Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <select id="delete-tag-select" class="form-control" style="width: 100%;"></select>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirm-delete-tag-btn" class="btn btn-danger">Delete Tag</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  let currentTripId = null;

  // When a Trip Issues button is clicked
  document.querySelectorAll('.trip-issues-btn').forEach(function(btn){
    btn.addEventListener('click', function(){
      currentTripId = this.getAttribute('data-trip-id');
      document.getElementById('modal-trip-id').textContent = currentTripId;
      // Open the modal (assumes Bootstrap 5)
      var tripModal = new bootstrap.Modal(document.getElementById('tripIssuesModal'));
      tripModal.show();

      // Populate the multi-select with all tags
      fetch('/get_tags')
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('trip-issues-select');
          select.innerHTML = '';
          data.tags.forEach(tag => {
            let option = document.createElement('option');
            option.value = tag.name;
            option.text = tag.name;
            select.add(option);
          });
          // Preselect existing tags if any, from data attribute
          const existing = btn.getAttribute('data-trip-issues');
          if(existing){
            const tags = existing.split(',').map(t => t.trim()).filter(t => t);
            for(let opt of select.options){
              if(tags.includes(opt.value)){
                opt.selected = true;
              }
            }
          }
        });
    });
  });

  // Save changes for trip issues
  document.getElementById('save-trip-issues-btn').addEventListener('click', function(){
    const select = document.getElementById('trip-issues-select');
    const selected = Array.from(select.selectedOptions).map(opt => opt.value);
    fetch('/update_trip_tags', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trip_id: currentTripId, tags: selected })
    })
    .then(response => response.json())
    .then(data => {
      if(data.status === 'success'){
        // Update the button text accordingly
        document.querySelector(`.trip-issues-btn[data-trip-id='${currentTripId}']`).textContent = selected.length > 0 ? 'Edit' : 'Add';
        // Also update its data attribute
        document.querySelector(`.trip-issues-btn[data-trip-id='${currentTripId}']`).setAttribute('data-trip-issues', selected.join(', '));
        bootstrap.Modal.getInstance(document.getElementById('tripIssuesModal')).hide();
      } else {
        alert(data.message);
      }
    });
  });

  // Open New Tag Modal from within the Trip Issues Modal
  document.getElementById('open-new-tag-modal').addEventListener('click', function(){
    var newTagModal = new bootstrap.Modal(document.getElementById('newTagModal'));
    newTagModal.show();
  });

  // Handle Create New Tag
  document.getElementById('save-new-tag-btn').addEventListener('click', function(){
    const newTagName = document.getElementById('new-tag-input').value.trim();
    if(newTagName === ''){
      alert('Please enter a tag name');
      return;
    }
    fetch('/create_tag', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: newTagName })
    })
    .then(response => response.json())
    .then(data => {
      if(data.status === 'success'){
        // Add the new tag to the multi-select dropdown
        const select = document.getElementById('trip-issues-select');
        let option = document.createElement('option');
        option.value = data.tag.name;
        option.text = data.tag.name;
        option.selected = true;
        select.add(option);
        document.getElementById('new-tag-input').value = '';
        bootstrap.Modal.getInstance(document.getElementById('newTagModal')).hide();
      } else {
        alert(data.message);
      }
    });
  });

  // 'Add New Tag' button outside the table opens the New Tag Modal
  document.getElementById('add-new-tag-btn').addEventListener('click', function(){
    var newTagModal = new bootstrap.Modal(document.getElementById('newTagModal'));
    newTagModal.show();
  });

  // Handle Delete Tag button click
  document.getElementById('delete-tag-btn').addEventListener('click', function(){
    // Populate the delete tag select with available tags
    fetch('/get_tags')
      .then(response => response.json())
      .then(data => {
        const select = document.getElementById('delete-tag-select');
        select.innerHTML = '';
        data.tags.forEach(tag => {
          let option = document.createElement('option');
          option.value = tag.name;
          option.text = tag.name;
          select.add(option);
        });
        // Show the delete tag modal
        var deleteTagModal = new bootstrap.Modal(document.getElementById('deleteTagModal'));
        deleteTagModal.show();
      });
  });

  // Handle confirm delete tag
  document.getElementById('confirm-delete-tag-btn').addEventListener('click', function(){
    const select = document.getElementById('delete-tag-select');
    const tagName = select.value;
    if (!tagName) {
        alert('Please select a tag to delete.');
        return;
    }
    if (!confirm('Are you sure you want to delete the tag "' + tagName + '"? This action cannot be undone.')) {
        return;
    }
    fetch('/delete_tag', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name: tagName})
    })
    .then(response => response.json())
    .then(data => {
        if(data.status === 'success'){
            alert('Tag deleted successfully.');
            bootstrap.Modal.getInstance(document.getElementById('deleteTagModal')).hide();
            // Remove deleted tag from trip issues select if present
            document.querySelectorAll('#trip-issues-select option').forEach(function(opt){
                if(opt.value === tagName) {
                    opt.remove();
                }
            });
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error deleting tag: ' + error);
    });
  });
});

function cleanForm(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);
  const cleanedParams = new URLSearchParams();

  // Create a map of operator fields to their corresponding value fields
  const operatorPairs = {
    'trip_time_op': 'trip_time',
    'log_count_op': 'log_count',
    'medium_segments_op': 'medium_segments',
    'long_segments_op': 'long_segments',
    'short_dist_total_op': 'short_dist_total',
    'medium_dist_total_op': 'medium_dist_total',
    'long_dist_total_op': 'long_dist_total',
    'max_segment_distance_op': 'max_segment_distance',
    'avg_segment_distance_op': 'avg_segment_distance'
  };

  // First pass: collect all values
  const values = {};
  for (const [key, value] of formData.entries()) {
    values[key] = value.trim();
  }

  // Second pass: add only non-empty parameters to URL
  for (const [key, value] of formData.entries()) {
    const trimmedValue = value.trim();
    
    // Skip empty values and default values
    if (!trimmedValue) continue;
    if (key === 'export_name' && trimmedValue === 'exported_trips') continue;
    if (key === 'status' && trimmedValue === 'completed') continue;

    // Handle operator fields
    if (key.endsWith('_op')) {
      const valueField = operatorPairs[key];
      // Only include operator if it has a corresponding non-empty value
      if (values[valueField]) {
        if (trimmedValue !== 'equal') { // Only include non-default operators
          cleanedParams.append(key, trimmedValue);
        }
      }
    }
    // Handle regular fields
    else {
      const operatorField = key + '_op';
      // If this is a value field with an operator, only include it if it has a value
      if (Object.values(operatorPairs).includes(key)) {
        if (values[key]) {
          cleanedParams.append(key, trimmedValue);
        }
      }
      // For all other fields, include if they have a value
      else {
        cleanedParams.append(key, trimmedValue);
      }
    }
  }

  // Add page parameter if it exists and is not 1
  const urlParams = new URLSearchParams(window.location.search);
  const page = urlParams.get('page');
  if (page && page !== '1') {
    cleanedParams.append('page', page);
  }

  const queryString = cleanedParams.toString();
  window.location.href = `${form.action}${queryString ? '?' + queryString : ''}`;
  return false;
}
</script>
{% endblock %}
